<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Compras - Admin</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    :root {
      --bg: #f9f9fb;
      --text: #222;
      --accent: #4a6cf7;
      --panel-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --border: rgba(255,255,255,0.3);
      --radius: 14px;
      --transition: 0.3s ease;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --accent: #6c8cff;
      --panel-bg: rgba(30, 30, 30, 0.92);
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
      --border: rgba(255,255,255,0.1);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text); padding-top: 64px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* BARRA SUPERIOR */
    .admin-bar {
      position: fixed; top: 0; left: 0; width: 100%; height: 64px;
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
      box-shadow: var(--shadow); z-index: 2000;
      display: flex; align-items: center; padding: 0 20px; gap: 16px;
      transition: background 0.3s ease;
    }

    [data-theme="dark"] .admin-bar {
      background: rgba(18, 18, 18, 0.95);
    }

    .back-btn {
      background: none; border: none; font-size: 1.4rem; color: #666;
      cursor: pointer; padding: 8px; border-radius: 50%; transition: var(--transition);
    }
    .back-btn:hover { background: #f0f0f0; color: #000; }

    [data-theme="dark"] .back-btn { color: #aaa; }
    [data-theme="dark"] .back-btn:hover { background: #333; color: #fff; }

    .title {
      flex: 1; font-size: 1.1rem; font-weight: 600; color: #333;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    [data-theme="dark"] .title { color: #eee; }

    .stats-btn {
      background: #f8f9ff; color: var(--accent); border: none;
      padding: 9px 14px; border-radius: 8px; font-weight: 600; font-size: 0.9rem;
      cursor: pointer; display: flex; align-items: center; gap: 6px;
      transition: var(--transition); box-shadow: 0 1px 3px rgba(74,108,247,0.15);
    }
    .stats-btn:hover {
      background: #eef0ff; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(74,108,247,0.2);
    }
    .stats-btn i { font-size: 1rem; }

    [data-theme="dark"] .stats-btn {
      background: rgba(108, 140, 255, 0.15); color: #8ca8ff;
    }
    [data-theme="dark"] .stats-btn:hover {
      background: rgba(108, 140, 255, 0.25); box-shadow: 0 2px 6px rgba(108, 140, 255, 0.3);
    }

    .logout-btn {
      background: #fff; color: #666; border: 1px solid #ddd;
      padding: 8px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: var(--transition);
    }
    .logout-btn:hover { background: #f5f5f5; color: #000; }

    [data-theme="dark"] .logout-btn {
      background: #2a2a2a; color: #ccc; border: 1px solid #444;
    }
    [data-theme="dark"] .logout-btn:hover { background: #333; color: #fff; }

    /* BOTÓN MODO OSCURO */
    .theme-toggle {
      background: none; border: none; font-size: 1.3rem; color: #666;
      cursor: pointer; padding: 8px; border-radius: 50%; transition: var(--transition);
    }
    .theme-toggle:hover { background: #f0f0f0; color: #000; }

    [data-theme="dark"] .theme-toggle { color: #ccc; }
    [data-theme="dark"] .theme-toggle:hover { background: #333; color: #fff; }

    /* MAPA */
    .map-container { position: relative; height: calc(100vh - 64px); overflow: hidden; }
    #map { width: 100%; height: 100%; }

    /* LEYENDA */
    .legend {
      position: absolute; bottom: 16px; left: 16px; background: var(--panel-bg);
      backdrop-filter: blur(12px); padding: 14px 16px; border-radius: var(--radius);
      box-shadow: var(--shadow); font-size: 0.85rem; min-width: 170px;
      transition: all var(--transition); z-index: 1000;
      border: 1px solid var(--border);
    }
    .legend.hidden { opacity: 0; transform: translateY(30px); pointer-events: none; }
    .legend h4 {
      margin: 0 0 8px; font-size: 0.92rem; font-weight: 600; color: #444;
      display: flex; justify-content: space-between; align-items: center;
    }
    [data-theme="dark"] .legend h4 { color: #ddd; }
    .close-legend {
      background: none; border: none; font-size: 1.1rem; color: #bbb;
      cursor: pointer; padding: 2px; border-radius: 4px;
    }
    .close-legend:hover { color: #999; background: #f0f0f0; }
    [data-theme="dark"] .close-legend:hover { background: #444; color: #fff; }
    .legend-item {
      display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.81rem;
    }
    .legend-color {
      width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
    }

    /* ESTADÍSTICAS */
    .stats-panel {
      position: absolute; top: 80px; right: 16px; width: 280px; background: var(--panel-bg);
      backdrop-filter: blur(12px); padding: 16px; border-radius: var(--radius);
      box-shadow: var(--shadow); transition: all var(--transition); z-index: 1000;
      border: 1px solid var(--border);
    }
    .stats-panel.hidden { opacity: 0; transform: translateX(320px); pointer-events: none; }
    .stats-panel h3 {
      margin: 0 0 12px; font-size: 1.1rem; font-weight: 600; color: #333;
      display: flex; justify-content: space-between; align-items: center;
    }
    [data-theme="dark"] .stats-panel h3 { color: #eee; }
    .close-stats {
      background: none; border: none; font-size: 1.1rem; color: #bbb;
      cursor: pointer; padding: 2px; border-radius: 4px;
    }
    .close-stats:hover { color: #999; background: #f0f0f0; }
    [data-theme="dark"] .close-stats:hover { background: #444; color: #fff; }
    .stat { margin-bottom: 10px; }
    .stat-label { font-size: 0.75rem; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
    [data-theme="dark"] .stat-label { color: #aaa; }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: #222; margin-top: 2px; }
    [data-theme="dark"] .stat-value { color: #fff; }
  </style>
</head>
<body data-theme="light">

  <!-- BARRA SUPERIOR -->
  <div class="admin-bar">
    <button class="back-btn" id="backBtnHeader" title="Volver">←</button>
    <div class="title">Mapa de Compras</div>
    
    <!-- BOTÓN MODO OSCURO -->
    <button class="theme-toggle" id="themeToggle" title="Modo Oscuro">
      <i class="fa-solid fa-moon"></i>
    </button>

    <button class="stats-btn" id="statsBtn">
      <i class="fa fa-chart-bar"></i> Estadísticas
    </button>
    <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
  </div>

  <!-- MAPA -->
  <div class="map-container">
    <div id="map"></div>

    <!-- LEYENDA -->
    <div class="legend" id="legendPanel">
      <h4>
        Leyenda
        <button class="close-legend" id="closeLegendBtn">×</button>
      </h4>
      <div class="legend-item">
        <div class="legend-color" style="background:#2ecc71;"></div>
        <span>1 compra</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#f1c40f;"></div>
        <span>2–5 compras</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#e67e22;"></div>
        <span>6–10 compras</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#e74c3c;"></div>
        <span>11–20 compras</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#c0392b;"></div>
        <span>20+ compras</span>
      </div>
    </div>

    <!-- ESTADÍSTICAS -->
    <div class="stats-panel" id="statsPanel">
      <h3>
        Resumen
        <button class="close-stats" id="closeStatsBtn">×</button>
      </h3>
      <div class="stat">
        <div class="stat-label">Total Órdenes</div>
        <div class="stat-value" id="totalOrders">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Ingresos Totales</div>
        <div class="stat-value" id="totalRevenue">$0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Estado Líder</div>
        <div class="stat-value" id="topState">-</div>
      </div>
    </div>
  </div>

  <!-- FIREBASE & LEAFLET -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
      authDomain: "boutique-buendia.firebaseapp.com",
      projectId: "boutique-buendia",
      storageBucket: "boutique-buendia.firebasestorage.app",
      messagingSenderId: "430651152709",
      appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c",
      measurementId: "G-9KJ2330RN7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === VERIFICAR ADMIN ===
    if (localStorage.getItem('isAdmin') !== 'true') {
      alert('Acceso denegado');
      window.location.href = 'index.html';
    }

    // === MAPA ===
    const map = L.map('map', {
      center: [23.5, -102],
      zoom: 5,
      minZoom: 2,
      maxZoom: 18,
      worldCopyJump: true,
      zoomControl: false,
      attributionControl: false
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 20,
      retina: true
    }).addTo(map);

    L.control.zoom({
      position: 'bottomright',
      zoomInTitle: 'Acercar',
      zoomOutTitle: 'Alejar'
    }).addTo(map);

    // === COORDENADAS ===
    const stateCoords = {
      AGS: [21.88, -102.29], BC: [30.0, -115.0], BCS: [26.0, -111.5], CAM: [18.6, -90.7],
      CHIS: [16.5, -92.5], CHIH: [28.6, -106.0], CDMX: [19.43, -99.13], COAH: [27.0, -102.0],
      COL: [19.2, -103.7], DGO: [24.0, -104.6], GTO: [21.0, -101.0], GRO: [17.5, -99.5],
      HGO: [20.5, -98.5], JAL: [20.6, -103.3], MEX: [19.3, -99.6], MICH: [19.0, -101.5],
      MOR: [18.9, -99.0], NAY: [21.5, -104.8], NL: [25.6, -100.3], OAX: [17.0, -96.7],
      PUE: [19.0, -98.0], QRO: [20.6, -100.3], QROO: [19.2, -88.5], SLP: [22.1, -100.9],
      SIN: [24.5, -107.5], SON: [29.0, -110.9], TAB: [17.9, -92.9], TAM: [24.0, -98.5],
      TLAX: [19.4, -98.2], VER: [19.2, -96.1], YUC: [20.7, -89.1], ZAC: [22.7, -102.5]
    };

    // === COLOR POR COMPRAS ===
    function getColor(count) {
      if (count === 1) return '#2ecc71';
      if (count <= 5)  return '#f1c40f';
      if (count <= 10) return '#e67e22';
      if (count <= 20) return '#e74c3c';
      return '#c0392b';
    }

    // === CONTADORES ===
    let totalOrders = 0;
    let totalRevenue = 0;
    const stateCount = {};

    // === CARGAR ÓRDENES ===
    db.collection('orders').get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.address && data.address.stateCode) {
          totalOrders++;
          totalRevenue += data.total || 0;
          const code = data.address.stateCode;
          stateCount[code] = (stateCount[code] || 0) + 1;
          const coords = stateCoords[code];
          if (coords) {
            const count = stateCount[code];
            const radius = Math.min(10 + count * 1.5, 40);
            const color = getColor(count);
            const opacity = count > 20 ? 0.9 : count > 10 ? 0.8 : count > 5 ? 0.7 : 0.6;

            L.circleMarker(coords, {
              radius: radius,
              color: color,
              fillColor: color,
              fillOpacity: opacity,
              weight: 2
            }).addTo(map)
              .bindPopup(`
                <b>${data.address.name || 'Cliente'}</b><br>
                ${data.address.state || 'Estado'}<br>
                Orden: <b>${doc.id}</b><br>
                Total: <b>$${data.total}</b><br>
                Fecha: ${new Date(data.date?.toDate()).toLocaleDateString('es-MX')}<br>
                <small><i>${count} compra${count > 1 ? 's' : ''} aquí</i></small>
              `);
          }
        }
      });

      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
      const top = Object.entries(stateCount).sort((a,b) => b[1] - a[1])[0];
      if (top) document.getElementById('topState').textContent = `${top[0]} (${top[1]})`;
    });

    // === MODO OSCURO FUNCIONAL ===
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('i');

    // Cargar tema guardado
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.setAttribute('data-theme', savedTheme);
    themeIcon.className = savedTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';

    // Alternar tema
    themeToggle.addEventListener('click', () => {
      const isDark = body.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeIcon.className = newTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    });

    // === PANELES ===
    const statsPanel = document.getElementById('statsPanel');
    const legendPanel = document.getElementById('legendPanel');
    const statsBtn = document.getElementById('statsBtn');
    const closeStatsBtn = document.getElementById('closeStatsBtn');
    const closeLegendBtn = document.getElementById('closeLegendBtn');

    statsBtn.addEventListener('click', () => {
      const bothHidden = statsPanel.classList.contains('hidden') && legendPanel.classList.contains('hidden');
      if (bothHidden) {
        statsPanel.classList.remove('hidden');
        legendPanel.classList.remove('hidden');
      } else {
        statsPanel.classList.add('hidden');
        legendPanel.classList.add('hidden');
      }
    });

    closeStatsBtn.addEventListener('click', () => statsPanel.classList.add('hidden'));
    closeLegendBtn.addEventListener('click', () => legendPanel.classList.add('hidden'));

    // === NAVEGACIÓN ===
    document.getElementById('backBtnHeader').onclick = () => window.location.href = 'admin.html';
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('isAdmin');
      localStorage.removeItem('loggedIn');
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>
