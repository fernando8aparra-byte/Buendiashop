<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa de Ventas Global - Boutique Buendía</title>

  <!-- Globe.gl + Three.js -->
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>

  <style>
    body {
      margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff;
      font-family: 'Segoe UI', sans-serif; height: 100vh;
    }
    #globeViz { width: 100%; height: 100%; }
    .panel {
      position: absolute; background: rgba(15,20,40,0.92); backdrop-filter: blur(16px);
      border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      border: 1px solid rgba(88,166,255,0.3); z-index: 10;
    }
    .legend { bottom: 20px; left: 20px; min-width: 220px; }
    .stats { top: 20px; right: 20px; width: 340px; }
    .title-bar {
      position: absolute; top: 0; left: 0; width: 100%; height: 70px;
      background: rgba(10,15,35,0.9); backdrop-filter: blur(12px); z-index: 100;
      display: flex; align-items: center; padding: 0 24px; gap: 16px;
      border-bottom: 1px solid #333;
    }
    .title { font-size: 1.4rem; font-weight: 700; letter-spacing: 0.8px; }
    .btn {
      background: none; border: none; color: #aaa; font-size: 1.5rem;
      cursor: pointer; padding: 10px; border-radius: 50%; transition: 0.3s;
    }
    .btn:hover { background: rgba(255,255,255,0.1); color: #58a6ff; }
    .stat-big { font-size: 2.2rem; font-weight: 800; color: #58a6ff; }
    .tooltip {
      position: absolute; background: rgba(0,0,0,0.9); color: white;
      padding: 10px 14px; border-radius: 10px; font-size: 0.95rem;
      pointer-events: none; z-index: 1000; transform: translate(-50%, -130%);
      box-shadow: 0 4px 20px rgba(0,0,0,0.8);
    }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="title-bar">
    <button class="btn" onclick="history.back()">Back</button>
    <div class="title">Mapa de Ventas Global - Boutique Buendía</div>
    <button class="btn" id="themeBtn">Moon</button>
  </div>

  <div id="globeViz"></div>

  <!-- Leyenda -->
  <div class="panel legend">
    <h4>Leyenda de Ventas</h4>
    <div style="margin:8px 0"><i class="fas fa-circle" style="color:#2ecc71"></i> 1 venta</div>
    <div style="margin:8px 0"><i class="fas fa-circle" style="color:#f1c40f"></i> 2–20 ventas</div>
    <div style="margin:8px 0"><i class="fas fa-circle" style="color:#e67e22"></i> 21–100 ventas</div>
    <div style="margin:8px 0"><i class="fas fa-circle" style="color:#e74c3c"></i> 101–300 ventas</div>
    <div style="margin:8px 0"><i class="fas fa-circle" style="color:#c0392b"></i> 300+ ventas</div>
  </div>

  <!-- Estadísticas -->
  <div class="panel stats">
    <h3>Insights Globales</h3>
    <div style="margin:12px 0">
      <div style="color:#888; font-size:0.9rem">Total Órdenes</div>
      <div class="stat-big" id="totalOrders">0</div>
    </div>
    <div style="margin:12px 0">
      <div style="color:#888; font-size:0.9rem">Ingresos Totales</div>
      <div class="stat-big" id="totalRevenue">$0</div>
    </div>
    <div style="margin:20px 0 8px 0; font-weight:600">Top Sucursales</div>
    <div id="topBranches"></div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip hidden"></div>

  <script>
    // Datos de ejemplo (puedes reemplazar con tu Firebase más adelante)
    const salesData = [
      { branch: "CDMX Centro", lat: 19.4326, lng: -99.1332, sales: 34200, orders: 389 },
      { branch: "Guadalajara", lat: 20.6597, lng: -103.3496, sales: 28900, orders: 312 },
      { branch: "Monterrey", lat: 25.6866, lng: -100.3161, sales: 26700, orders: 298 },
      { branch: "Tijuana", lat: 32.5251, lng: -117.0336, sales: 12500, orders: 142 },
      { branch: "Cancún", lat: 21.1619, lng: -86.8515, sales: 18900, orders: 201 },
      { branch: "Madrid", lat: 40.4168, lng: -3.7038, sales: 45200, orders: 498 },
      { branch: "Bogotá", lat: 4.7110, lng: -74.0721, sales: 9800, orders: 89 },
      { branch: "Lima", lat: -12.0464, lng: -77.0428, sales: 11200, orders: 105 },
      { branch: "Mérida", lat: 20.9674, lng: -89.5926, sales: 8700, orders: 94 },
      { branch: "Puebla", lat: 19.0414, lng: -98.2063, sales: 15600, orders: 178 },
    ];

    // Cálculo de estadísticas
    const totalOrders = salesData.reduce((a,b) => a + b.orders, 0);
    const totalRevenue = salesData.reduce((a,b) => a + b.sales, 0);
    document.getElementById('totalOrders').textContent = totalOrders.toLocaleString();
    document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString();

    const top5 = [...salesData].sort((a,b) => b.sales - a.sales).slice(0,5);
    document.getElementById('topBranches').innerHTML = top5.map(p => 
      `<div style="margin:6px 0; display:flex; justify-content:space-between">
         <span>${p.branch}</span>
         <strong>$${p.sales.toLocaleString()}</strong>
       </div>`
    ).join('');

    // Globe.gl
    const globe = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .pointOfView({ altitude: 1.8 })
      .pointsData(salesData)
      .pointLat('lat')
      .pointLng('lng')
      .pointAltitude(d => Math.max(0.02, d.sales / 200000))
      .pointRadius(d => Math.sqrt(d.orders) / 5)
      .pointColor(d => {
        if (d.orders <= 1) return '#2ecc71';
        if (d.orders <= 20) return '#f1c40f';
        if (d.orders <= 100) return '#e67e22';
        if (d.orders <= 300) return '#e74c3c';
        return '#c0392b';
      })
      .pointLabel(d => `
        <b>${d.branch}</b><br/>
        Ventas: <b>$${d.sales.toLocaleString()}</b><br/>
        Órdenes: <b>${d.orders}</b>
      `)
      .onPointHover((point, prevPoint) => {
        const tooltip = document.getElementById('tooltip');
        if (point) {
          tooltip.classList.remove('hidden');
          tooltip.innerHTML = point.pointLabel;
          tooltip.style.left = event.clientX + 'px';
          tooltip.style.top = event.clientY + 'px';
        } else {
          tooltip.classList.add('hidden');
        }
      })
      (document.getElementById('globeViz'));

    // Tema oscuro/claro
    document.getElementById('themeBtn').onclick = () => {
      document.body.style.background = document.body.style.background === 'black' ? '#f0f0f0' : 'black';
      document.body.style.color = document.body.style.color === 'white' ? '#222' : 'white';
      globe.backgroundImageUrl(document.body.style.background === 'black' 
        ? '//unpkg.com/three-globe/example/img/night-sky.png'
        : '//unpkg.com/three-globe/example/img/day-sky.png');
    };

    // Rotación automática suave
    (function rotate() {
      const pov = globe.pointOfView();
      globe.pointOfView({ ...pov, lng: pov.lng + 0.15 }, 100);
      requestAnimationFrame(rotate);
    })();
  </script>
</body>
</html>
