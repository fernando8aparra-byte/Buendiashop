<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin - Boutique Buendía</title>
<style>
:root {
  --bg: #ffffff;
  --text: #111;
  --muted: #777;
  --card-bg: #fff;
  --accent: #7c4dff;
  --shadow: 0 8px 20px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,sans-serif;}
body{background:var(--bg);color:var(--text);}
header{background:var(--card-bg);border-bottom:1px solid #ddd;position:sticky;top:0;z-index:20;}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;}
.logo{font-size:24px;font-weight:900;letter-spacing:1px;}
.header-actions{display:flex;align-items:center;gap:14px;}
.icon{cursor:pointer;font-size:20px;position:relative;}
button{cursor:pointer;}
.main-content{max-width:1200px;margin:auto;padding:20px;}
.page-title{font-size:32px;margin-bottom:20px;font-weight:800;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:22px;}
.card{background:var(--card-bg);border-radius:10px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .2s;cursor:pointer;}
.card:hover{transform:translateY(-4px);}
.card img{width:100%;height:auto;aspect-ratio:1/1;object-fit:contain;background:#f9f9f9;}
.card .meta{padding:14px;flex:1;display:flex;flex-direction:column;}
.card .title{font-size:14px;font-weight:600;margin-bottom:6px;}
.card .price{font-weight:800;font-size:16px;margin-bottom:8px;}
.card .description{font-size:12px;color:var(--muted);margin-bottom:12px;}
.card .actions{display:flex;justify-content:space-between;gap:6px;}
.card .actions button{padding:6px 10px;border-radius:6px;font-weight:600;border:none;color:#fff;}
.edit-btn{background:#ffc107;}
.delete-btn{background:#dc3545;}
.toggle-btn{background:#28a745;}
.form-panel{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:20px;}
.form-panel input, .form-panel select{width:100%;padding:10px;margin-bottom:12px;border:1px solid #ddd;border-radius:6px;}
.form-panel label{font-weight:600;margin-bottom:6px;display:block;}
.form-panel button{background:var(--accent);color:#fff;padding:12px;border:none;border-radius:8px;font-weight:600;}
.stats-panel{margin-bottom:20px;}
.stats-panel h2{font-size:20px;margin-bottom:12px;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;}
.stats-card{background:var(--card-bg);padding:16px;border-radius:10px;box-shadow:var(--shadow);}
.switch-label{display:flex;align-items:center;justify-content:space-between;font-weight:600;}
.switch-label input{transform:scale(1.2);}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">Admin - Boutique Buendía</div>
    <div class="header-actions">
      <button id="logoutBtn">Cerrar sesión</button>
    </div>
  </div>
</header>

<main class="main-content">
  <h1 class="page-title">Panel de administración</h1>

  <!-- Formulario para agregar producto -->
  <div class="form-panel">
    <h2>Agregar / Editar Producto</h2>
    <label>Nombre del producto</label>
    <input type="text" id="productName">
    <label>Descripción</label>
    <input type="text" id="productDesc">
    <label>Precio</label>
    <input type="number" id="productPrice">
    <label>Categoría</label>
    <select id="productCategory">
      <option value="gorras">Gorras</option>
      <option value="camisetas">Camisetas</option>
      <option value="cintos">Cintos</option>
      <option value="pantalones">Pantalones</option>
      <option value="tenis">Tenis</option>
      <option value="sudaderas">Sudaderas</option>
    </select>
    <label>Tipo de producto</label>
    <select id="productType">
      <option value="normal">Normal</option>
      <option value="principal">Producto principal</option>
      <option value="publicidad">Publicidad</option>
      <option value="carrusel">Carrusel</option>
    </select>
    <label>Imagen (subir desde dispositivo)</label>
    <input type="file" id="productImageFile">
    <label>Imagen (URL)</label>
    <input type="text" id="productImageURL">
    <button id="saveProductBtn">Guardar producto</button>
  </div>

  <!-- Productos existentes -->
  <div>
    <h2>Productos agregados</h2>
    <div class="grid" id="productsGridAdmin">
      <!-- Productos se cargan aquí -->
    </div>
  </div>

  <!-- Estadísticas -->
  <div class="stats-panel">
    <h2>Estadísticas</h2>
    <div class="stats-grid">
      <div class="stats-card" id="totalUsers">Usuarios registrados: 0</div>
      <div class="stats-card" id="totalCompras">Compras totales: 0</div>
      <div class="stats-card" id="totalVentas">Ventas totales: $0.00</div>
    </div>
  </div>

</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// Configura Firebase
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_STORAGE_BUCKET",
  messagingSenderId: "TU_MSG_ID",
  appId: "TU_APP_ID"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();

// Variables
const productName = document.getElementById('productName');
const productDesc = document.getElementById('productDesc');
const productPrice = document.getElementById('productPrice');
const productCategory = document.getElementById('productCategory');
const productType = document.getElementById('productType');
const productImageFile = document.getElementById('productImageFile');
const productImageURL = document.getElementById('productImageURL');
const saveProductBtn = document.getElementById('saveProductBtn');
const productsGridAdmin = document.getElementById('productsGridAdmin');
const totalUsers = document.getElementById('totalUsers');
const totalCompras = document.getElementById('totalCompras');
const totalVentas = document.getElementById('totalVentas');
const logoutBtn = document.getElementById('logoutBtn');

// -------------------------
// Funciones de productos
// -------------------------
function renderProductsAdmin(products){
  productsGridAdmin.innerHTML = '';
  products.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${data.imagen}" alt="${data.nombre}">
      <div class="meta">
        <div class="title">${data.nombre}</div>
        <div class="price">$${parseFloat(data.precio).toLocaleString('es-MX', {minimumFractionDigits:2})}</div>
        <div class="description">${data.descripcion}</div>
        <div class="actions">
          <button class="edit-btn" onclick="editProduct('${doc.id}')">Editar</button>
          <button class="delete-btn" onclick="deleteProduct('${doc.id}')">Eliminar</button>
          <label class="switch-label">Habilitar <input type="checkbox" ${data.habilitado ? 'checked' : ''} onchange="toggleProduct('${doc.id}', this.checked)"></label>
        </div>
      </div>
    `;
    productsGridAdmin.appendChild(card);
  });
}

// Cargar productos desde Firestore
function loadProducts(){
  db.collection('productos').get().then(snapshot=>{
    renderProductsAdmin(snapshot.docs);
  });
}

// Guardar producto
saveProductBtn.onclick = async ()=>{
  const nombre = productName.value.trim();
  const descripcion = productDesc.value.trim();
  const precio = parseFloat(productPrice.value);
  const categoria = productCategory.value;
  const tipo = productType.value;

  if(!nombre || !descripcion || !precio) return alert('Completa todos los campos');

  let imagen = '';
  if(productImageFile.files[0]){
    const file = productImageFile.files[0];
    const ref = storage.ref().child('productos/'+file.name);
    await ref.put(file);
    imagen = await ref.getDownloadURL();
  } else if(productImageURL.value){
    imagen = productImageURL.value;
  } else {
    imagen = 'https://via.placeholder.com/240?text=No+Image';
  }

  db.collection('productos').add({
    nombre,
    descripcion,
    precio,
    categoria,
    tipo,
    imagen,
    habilitado: true,
    creado: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    alert('Producto agregado');
    productName.value=''; productDesc.value=''; productPrice.value=''; productImageFile.value=''; productImageURL.value='';
    loadProducts();
  });
}

// Editar producto
function editProduct(id){
  const docRef = db.collection('productos').doc(id);
  docRef.get().then(doc=>{
    const data = doc.data();
    productName.value = data.nombre;
    productDesc.value = data.descripcion;
    productPrice.value = data.precio;
    productCategory.value = data.categoria;
    productType.value = data.tipo;
    // Guardar como actualización
    saveProductBtn.onclick = async ()=>{
      let imagen = data.imagen;
      if(productImageFile.files[0]){
        const file = productImageFile.files[0];
        const ref = storage.ref().child('productos/'+file.name);
        await ref.put(file);
        imagen = await ref.getDownloadURL();
      } else if(productImageURL.value){
        imagen = productImageURL.value;
      }
      docRef.update({
        nombre: productName.value,
        descripcion: productDesc.value,
        precio: parseFloat(productPrice.value),
        categoria: productCategory.value,
        tipo: productType.value,
        imagen
      }).then(()=>{
        alert('Producto actualizado');
        productName.value=''; productDesc.value=''; productPrice.value=''; productImageFile.value=''; productImageURL.value='';
        saveProductBtn.onclick = saveOriginalProduct;
        loadProducts();
      });
    };
  });
}

// Guardar original
const saveOriginalProduct = saveProductBtn.onclick;

// Eliminar producto
function deleteProduct(id){
  if(confirm('¿Deseas eliminar este producto?')){
    db.collection('productos').doc(id).delete().then(()=> loadProducts());
  }
}

// Habilitar/deshabilitar
function toggleProduct(id, estado){
  db.collection('productos').doc(id).update({habilitado: estado});
}

// -------------------------
// Estadísticas
// -------------------------
function loadStats(){
  db.collection('usuarios').get().then(snapshot=>{
    totalUsers.textContent = `Usuarios registrados: ${snapshot.size}`;
  });
  db.collection('compras').get().then(snapshot=>{
    let total = 0;
    snapshot.forEach(doc=>{
      total += doc.data().total;
    });
    totalCompras.textContent = `Compras totales: ${snapshot.size}`;
    totalVentas.textContent = `Ventas totales: $${total.toLocaleString('es-MX', {minimumFractionDigits:2})}`;
  });
}

// -------------------------
// Logout
// -------------------------
logoutBtn.onclick = ()=>{
  auth.signOut().then(()=>window.location.href='login.html');
}

// Cargar productos y estadísticas al iniciar
document.addEventListener('DOMContentLoaded', ()=>{
  loadProducts();
  loadStats();
});

</script>
</body>
</html>
