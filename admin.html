// admin.js - 100% COMPATIBLE CON TU admin.html ACTUAL
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  onSnapshot,
  doc,
  addDoc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
  authDomain: "boutique-buendia.firebaseapp.com",
  projectId: "boutique-buendia",
  storageBucket: "boutique-buendia.firebasestorage.app",
  messagingSenderId: "430651152709",
  appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// === DOM ===
const addPostBtn = document.getElementById('addPostBtn');
const addProductModal = document.getElementById('addProductModal');
const editProductModal = document.getElementById('editProductModal');
const saveNewProduct = document.getElementById('saveNewProduct');
const cancelAdd = document.getElementById('cancelAdd');
const saveProduct = document.getElementById('saveProduct');
const cancelEdit = document.getElementById('cancelEdit');
const newCarousel = document.getElementById('newCarousel');
const starCarousel = document.getElementById('starCarousel');
const productsGrid = document.getElementById('productsGrid');
const toast = document.getElementById('toast');
const adminGear = document.getElementById('adminGear');
const adminDropdown = document.getElementById('adminDropdown');
const logoutBtn = document.getElementById('logoutBtn');

// === TOAST ===
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// === ABRIR MODAL AGREGAR ===
addPostBtn.onclick = () => {
  addProductModal.classList.add('active');
  document.getElementById('imagePreview').style.display = 'none';
};

// === CERRAR MODALES ===
[cancelAdd, cancelEdit].forEach(btn => {
  btn.onclick = () => {
    addProductModal.classList.remove('active');
    editProductModal.classList.remove('active');
  };
});

// === ENGRANAJE ADMIN ===
adminGear.onclick = (e) => {
  e.stopPropagation();
  adminDropdown.classList.toggle('show');
};
document.addEventListener('click', () => {
  adminDropdown.classList.remove('show');
});

// === CERRAR SESIÓN ===
logoutBtn.onclick = () => {
  localStorage.removeItem('isAdmin');
  localStorage.removeItem('loggedIn');
  localStorage.removeItem('userName');
  window.location.href = 'index.html';
};

// === AGREGAR PRODUCTO (ENVÍA type COMO OBJETO) ===
saveNewProduct.onclick = async () => {
  const nombre = document.getElementById('addName').value.trim();
  const precio = parseFloat(document.getElementById('addPrice').value);
  const tallasInput = document.getElementById('addSizes').value.trim();
  const descripcion = document.getElementById('addDesc').value.trim();
  const categoria = document.getElementById('addCategory').value;
  const typeSelect = document.getElementById('addType').value;
  const imagen = document.getElementById('addImage').value.trim();

  if (!nombre || isNaN(precio) || !imagen) {
    showToast('Completa nombre, precio e imagen');
    return;
  }

  const talla = tallasInput ? tallasInput.split(',').map(t => t.trim()) : [];

  try {
    await addDoc(collection(db, 'productos'), {
      nombre,
      precio,
      imagen,
      descripcion,
      talla,
      tipo: categoria,
      type: {
        anuncio: typeSelect === 'publicidad',
        carrusel: typeSelect === 'carrusel',
        normal: typeSelect === 'normal'
      }
    });
    showToast('Producto agregado');
    addProductModal.classList.remove('active');
    // Limpiar formulario
    document.getElementById('addName').value = '';
    document.getElementById('addPrice').value = '';
    document.getElementById('addSizes').value = '';
    document.getElementById('addDesc').value = '';
    document.getElementById('addImage').value = '';
  } catch (err) {
    console.error(err);
    showToast('Error al agregar');
  }
};

// === RENDER CARRUSEL ===
function renderCarousel(container, filterFn) {
  container.innerHTML = '';
  const filtered = window.allProducts.filter(filterFn);
  if (filtered.length === 0) {
    container.innerHTML = '<p style="color:#999;padding:15px;text-align:center;">No hay productos</p>';
    return;
  }
  [...filtered, ...filtered].forEach(p => {
    const item = document.createElement('div');
    item.className = 'carousel-item';
    item.style.minWidth = '200px';
    item.innerHTML = `<img src="${p.imagen}" alt="${p.nombre}" loading="lazy" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
    container.appendChild(item);
  });
}

// === RENDER GRILLA ===
function renderGrid() {
  productsGrid.innerHTML = '';
  const normales = window.allProducts.filter(p => p.type && p.type.normal);

  normales.forEach(p => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <img src="${p.imagen}" alt="${p.nombre}" loading="lazy">
      <h3>${p.nombre}</h3>
      <p class="product-desc-small">${p.descripcion || ''}</p>
      <p class="product-price">$${p.precio.toLocaleString()}</p>
      <div class="product-actions">
        <button class="admin-btn admin-edit" data-id="${p.id}">Editar</button>
        <button class="admin-btn admin-delete" data-id="${p.id}">Eliminar</button>
      </div>
    `;
    productsGrid.appendChild(card);
  });

  // EDITAR
  document.querySelectorAll('.admin-edit').forEach(btn => {
    btn.onclick = (e) => {
      const id = e.target.dataset.id;
      const product = window.allProducts.find(p => p.id === id);
      if (!product) return;

      document.getElementById('editName').value = product.nombre;
      document.getElementById('editPrice').value = product.precio;
      document.getElementById('editSizes').value = product.talla.join(', ');
      document.getElementById('editDesc').value = product.descripcion;
      document.getElementById('editType').value = product.tipo;
      document.getElementById('editImage').value = product.imagen;

      editProductModal.classList.add('active');
      window.currentEditId = id;
    };
  });

  // ELIMINAR
  document.querySelectorAll('.admin-delete').forEach(btn => {
    btn.onclick = async (e) => {
      if (!confirm('¿Eliminar este producto?')) return;
      const id = e.target.dataset.id;
      try {
        await deleteDoc(doc(db, 'productos', id));
        showToast('Producto eliminado');
      } catch (err) {
        showToast('Error al eliminar');
      }
    };
  });
}

// === GUARDAR EDICIÓN ===
saveProduct.onclick = async () => {
  const id = window.currentEditId;
  if (!id) return;

  const nombre = document.getElementById('editName').value.trim();
  const precio = parseFloat(document.getElementById('editPrice').value);
  const tallasInput = document.getElementById('editSizes').value.trim();
  const descripcion = document.getElementById('editDesc').value.trim();
  const tipo = document.getElementById('editType').value;
  const imagen = document.getElementById('editImage').value.trim();

  if (!nombre || isNaN(precio) || !imagen) {
    showToast('Completa todos los campos');
    return;
  }

  const talla = tallasInput ? tallasInput.split(',').map(t => t.trim()) : [];

  try {
    await updateDoc(doc(db, 'productos', id), {
      nombre,
      precio,
      imagen,
      descripcion,
      talla,
      tipo
    });
    showToast('Producto actualizado');
    editProductModal.classList.remove('active');
  } catch (err) {
    showToast('Error al actualizar');
  }
};

// === ESCUCHAR PRODUCTOS EN TIEMPO REAL ===
let allProducts = [];
onSnapshot(collection(db, 'productos'), (snapshot) => {
  allProducts = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    allProducts.push({
      id: doc.id,
      nombre: data.nombre || '',
      precio: data.precio || 0,
      imagen: data.imagen || '',
      descripcion: data.descripcion || '',
      talla: data.talla || [],
      tipo: data.tipo || '',
      type: data.type || { normal: true }
    });
  });
  window.allProducts = allProducts;

  renderCarousel(newCarousel, p => p.type && p.type.carrusel);
  renderCarousel(starCarousel, p => p.type && p.type.anuncio);
  renderGrid();
});

// === INICIO ===
if (localStorage.getItem('isAdmin') !== 'true') {
  alert('Acceso denegado');
  window.location.href = 'index.html';
}
