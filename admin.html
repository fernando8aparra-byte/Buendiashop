<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Efraín Shop</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* === ESTILOS ADMIN === */
    body { padding-top: 70px; font-family: 'Arial', sans-serif; }
    .admin-bar {
      position: fixed; top: 0; left: 0; width: 100%; background: #000; color: #fff;
      padding: 15px 20px; z-index: 2000; display: flex; justify-content: space-between;
      align-items: center; font-weight: 700; text-transform: uppercase; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .admin-bar .left { display: flex; gap: 15px; align-items: center; }
    .admin-bar .right { display: flex; gap: 15px; align-items: center; }

    /* ENGRANAJE + MENÚ */
    .settings-btn {
      background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; padding: 0;
    }
    .settings-menu {
      position: absolute; top: 60px; left: 20px; background: #000; border-radius: 8px; overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; min-width: 200px; z-index: 3000;
    }
    .settings-menu.active { display: block; }
    .settings-menu a {
      display: block; padding: 14px 18px; color: #fff; text-decoration: none; font-weight: 600;
      font-size: 1rem; border-bottom: 1px solid #333;
    }
    .settings-menu a:last-child { border-bottom: none; }
    .settings-menu a:hover { background: #333; }

    .add-btn {
      background: none; border: none; color: #fff; font-size: 1.8rem; font-weight: 800;
      cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    }

    /* CONTENEDOR PRINCIPAL */
    .main-container { padding: 20px; }

    /* SECCIÓN CONTENIDO FIRESTORE */
    .content-editor {
      background: #f8f8f8; padding: 25px; margin-bottom: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .content-editor h2 {
      margin-top: 0; font-size: 1.5rem; text-transform: uppercase; margin-bottom: 20px; color: #000;
    }
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; color: #333;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 14px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 1rem;
      font-family: inherit; resize: vertical;
    }
    .btn-save-content {
      background: #000; color: #fff; padding: 14px 24px; border: none; border-radius: 8px;
      font-weight: bold; font-size: 1rem; cursor: pointer; text-transform: uppercase;
    }
    .btn-save-content:hover { background: #111; }

    /* PRODUCTOS EN GRID */
    .products-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;
    }
    .product-card {
      background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative;
    }
    .product-card img { width: 100%; height: 180px; object-fit: cover; }
    .card-info { padding: 16px; }
    .product-title { margin: 0 0 8px; font-size: 1.1rem; font-weight: 700; }
    .product-description { font-size: 0.9rem; color: #666; margin-bottom: 12px; }
    .product-price { font-size: 1.3rem; font-weight: 800; color: #000; }
    .product-actions {
      position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.3s;
    }
    .product-card:hover .product-actions { opacity: 1; }
    .action-btn {
      background: #000; color: #fff; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
    }

    /* MODAL PRODUCTO */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000;
      align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative;
    }
    .modal-close {
      position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #000;
    }
    .btn-save { background: #000; color: #fff; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* SUBIDA DE IMAGEN */
    .image-upload {
      border: 2px dashed #ccc; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 15px;
      transition: border 0.3s;
    }
    .image-upload:hover { border-color: #000; }
    .image-upload input { display: none; }
    .image-preview {
      margin-top: 10px; max-width: 100%; max-height: 150px; border-radius: 8px; display: none;
    }

    /* TEXTOS EDITABLES */
    .editable {
      position: relative; cursor: pointer; min-height: 1.2em;
    }
    .text-actions {
      position: absolute; top: 4px; right: 4px; opacity: 0; transition: opacity 0.3s;
    }
    .editable:hover .text-actions { opacity: 1; }

    /* MANTENIMIENTO */
    .maintenance-banner {
      position: fixed; top: 0; left: 0; width: 100%; background: #ff0000; color: #fff; text-align: center; padding: 10px; font-weight: bold; z-index: 9999; display: none;
    }
    .maintenance-banner.show { display: block; }

    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #fff; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background: #28a745; }
    input:checked + .slider:before { transform: translateX(24px); }

    .loading { text-align: center; padding: 40px; color: #666; }
  </style>
</head>
<body>

  <!-- BANNER MANTENIMIENTO -->
  <div class="maintenance-banner" id="maintenanceBanner">PÁGINA EN MANTENIMIENTO</div>

  <!-- BARRA ADMIN -->
  <div class="admin-bar">
    <div class="left">
      <button class="settings-btn" id="settingsBtn">Gear</button>
      <div class="settings-menu" id="settingsMenu">
        <a href="admin-map.html">Mapa de Compras</a>
        <a href="admin-compras.html">Compras</a>
        <a href="admin-stats.html">Estadísticas</a>
      </div>
      <button class="add-btn" id="addProductBtn">+</button>
    </div>
    <div class="right">
      <label>Página en Servicio</label>
      <label class="switch">
        <input type="checkbox" id="maintenanceToggle" checked>
        <span class="slider"></span>
      </label>
      <button class="admin-btn" id="logoutBtn">Cerrar Sesión</button>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-container">

    <!-- EDICIÓN DE CONTENIDO -->
    <div class="content-editor">
      <h2>Editar Contenido Principal</h2>
      <div class="form-group">
        <label>Título (noticias/principal)</label>
        <input type="text" id="tituloInput">
      </div>
      <div class="form-group">
        <label>Texto (noticias/principal)</label>
        <textarea id="textoInput" rows="4"></textarea>
      </div>
      <div class="form-group">
        <label>Subtítulo (lanzamientos/texto)</label>
        <textarea id="subtituloInput" rows="3"></textarea>
      </div>
      <button class="btn-save-content" id="saveContentBtn">Guardar Cambios</button>
      <p id="saveStatus" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
    </div>

    <!-- VISTA PREVIA DEL INDEX -->
    <div class="content-editor">
      <h2>Vista Previa de la Tienda</h2>
      <div id="indexClone"></div>
    </div>
  </div>

  <!-- MODAL PRODUCTO -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <button class="modal-close" id="closeProductModal">X</button>
      <h3 id="modalTitle">Agregar Producto</h3>
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" id="productName">
      </div>
      <div class="form-group">
        <label>Precio</label>
        <input type="number" id="productPrice" step="0.01">
      </div>
      <div class="form-group">
        <label>Descripción</label>
        <textarea id="productDesc" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label>Tipo</label>
        <select id="productType">
          <option value="normal">Normal</option>
          <option value="carrusel">Carrusel</option>
          <option value="principal">Principal</option>
          <option value="publicidad">Publicidad</option>
        </select>
      </div>
      <div class="form-group">
        <label>Imagen</label>
        <div class="image-upload" id="imageUpload">
          <input type="file" id="imageInput" accept="image/*">
          <p>Haz clic para subir imagen</p>
          <img id="imagePreview" class="image-preview" src="" alt="Vista previa">
        </div>
        <input type="text" id="productImageUrl" readonly placeholder="URL de imagen">
      </div>
      <button class="btn-save" id="saveProductBtn">Guardar Producto</button>
    </div>
  </div>

  <!-- MODAL EDITAR TEXTO -->
  <div class="modal" id="editTextModal">
    <div class="modal-content">
      <button class="modal-close" id="closeTextModal">X</button>
      <h3>Editar Texto</h3>
      <div class="form-group">
        <label>Nuevo texto</label>
        <textarea id="editTextInput" rows="4"></textarea>
      </div>
      <button class="btn-save" id="saveTextBtn">Guardar</button>
    </div>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

  <script>
    // === FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
      authDomain: "boutique-buendia.firebaseapp.com",
      projectId: "boutique-buendia",
      storageBucket: "boutique-buendia.firebasestorage.app",
      messagingSenderId: "430651152709",
      appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c",
      measurementId: "G-9KJ2330RN7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // === VERIFICAR ADMIN ===
    if (localStorage.getItem('isAdmin') !== 'true') {
      alert('Acceso denegado');
      window.location.href = 'index.html';
    }

    // === VARIABLES GLOBALES ===
    let currentProductId = null;
    let currentTextElement = null;
    let currentTextDocPath = null;

    // === CARGAR CONTENIDO NOTICIAS Y LANZAMIENTOS ===
    async function loadContent() {
      try {
        const noticiaDoc = await db.collection('noticias').doc('principal').get();
        const lanzamientoDoc = await db.collection('lanzamientos').doc('texto').get();

        if (noticiaDoc.exists) {
          const data = noticiaDoc.data();
          document.getElementById('tituloInput').value = data.titulo || '';
          document.getElementById('textoInput').value = data.texto || '';
        }
        if (lanzamientoDoc.exists) {
          const data = lanzamientoDoc.data();
          document.getElementById('subtituloInput').value = data.subtitulo || '';
        }
      } catch (e) { console.error(e); }
    }

    // === GUARDAR CONTENIDO ===
    document.getElementById('saveContentBtn').onclick = async () => {
      const status = document.getElementById('saveStatus');
      status.textContent = 'Guardando...'; status.style.color = '#666';
      try {
        await db.collection('noticias').doc('principal').set({
          titulo: document.getElementById('tituloInput').value.trim(),
          texto: document.getElementById('textoInput').value.trim()
        }, { merge: true });

        await db.collection('lanzamientos').doc('texto').set({
          subtitulo: document.getElementById('subtituloInput').value.trim()
        }, { merge: true });

        status.textContent = '¡Cambios guardados!'; status.style.color = '#28a745';
      } catch (e) {
        status.textContent = 'Error'; status.style.color = '#e63946';
      }
    };

    // === CLONAR INDEX Y CARGAR PRODUCTOS ===
    fetch('index.html')
      .then(r => r.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const main = doc.querySelector('.main-container');
        if (main) {
          document.getElementById('indexClone').innerHTML = main.innerHTML;
          initAdmin();
          loadContent();
        }
      });

    function initAdmin() {
      // === CARGAR PRODUCTOS POR TIPO ===
      const heroContainer = document.querySelector('#indexClone .hero') || document.createElement('div');
      const carruselContainer = document.querySelector('#indexClone .carrusel') || document.createElement('div');
      const publicidadContainer = document.querySelector('#indexClone .publicidad') || document.createElement('div');
      const normalGrid = document.querySelector('#indexClone .products-grid');

      db.collection('productos').where('habilitado', '==', true).get().then(snapshot => {
        snapshot.forEach(doc => {
          const p = doc.data();
          const card = createProductCard(p, doc.id);
          if (p.tipo === 'principal' && heroContainer) heroContainer.appendChild(card.cloneNode(true));
          if (p.tipo === 'carrusel' && carruselContainer) carruselContainer.appendChild(card.cloneNode(true));
          if (p.tipo === 'publicidad' && publicidadContainer) publicidadContainer.appendChild(card.cloneNode(true));
          if (p.tipo === 'normal' && normalGrid) normalGrid.appendChild(card);
        });
      });

      function createProductCard(p, id) {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
          <div class="product-actions">
            <button class="action-btn" onclick="editProduct('${id}')">Edit</button>
            <button class="action-btn" onclick="deleteProduct('${id}')">Delete</button>
          </div>
          <img src="${p.imagen}" alt="${p.nombre}">
          <div class="card-info">
            <h3 class="product-title">${p.nombre}</h3>
            <p class="product-description">${p.descripcion}</p>
            <div class="price-container">
              <span class="product-price">${p.precioFormateado || `$${(p.precio || 0).toFixed(2)}`}</span>
            </div>
          </div>
        `;
        return div;
      }

      // === TEXTOS EDITABLES CON GUARDADO EN FIRESTORE ===
      const editableSelectors = '#indexClone h1, #indexClone h2, #indexClone h3, #indexClone p, #indexClone .tag, #indexClone .hero-title, #indexClone .hero-subtitle';
      document.querySelectorAll(editableSelectors).forEach(el => {
        el.classList.add('editable');
        const actions = document.createElement('div');
        actions.className = 'text-actions';
        actions.innerHTML = `<button class="action-btn" onclick="editText(this, '${getTextPath(el)}')">Edit</button>`;
        el.appendChild(actions);
      });

      function getTextPath(el) {
        if (el.closest('.hero')) return 'noticias/principal/titulo';
        if (el.classList.contains('hero-subtitle')) return 'noticias/principal/texto';
        if (el.closest('.lanzamientos')) return 'lanzamientos/texto/subtitulo';
        return null;
      }

      window.editText = (btn, path) => {
        currentTextElement = btn.parentElement.parentElement;
        currentTextDocPath = path;
        document.getElementById('editTextInput').value = currentTextElement.innerText.trim();
        document.getElementById('editTextModal').classList.add('active');
      };

      document.getElementById('saveTextBtn').onclick = async () => {
        if (currentTextElement && currentTextDocPath) {
          const [collection, doc, field] = currentTextDocPath.split('/');
          try {
            await db.collection(collection).doc(doc).update({ [field]: document.getElementById('editTextInput').value });
            currentTextElement.innerHTML = document.getElementById('editTextInput').value +
              '<div class="text-actions"><button class="action-btn" onclick="editText(this, \'' + currentTextDocPath + '\')">Edit</button></div>';
            document.getElementById('editTextModal').classList.remove('active');
          } catch (e) { alert('Error al guardar texto'); }
        }
      };

      // === MODAL PRODUCTO ===
      const modal = document.getElementById('productModal');
      const closeModal = document.getElementById('closeProductModal');

      document.getElementById('addProductBtn').onclick = () => {
        currentProductId = null;
        document.getElementById('modalTitle').textContent = 'Agregar Producto';
        clearProductForm();
        modal.classList.add('active');
      };

      closeModal.onclick = () => modal.classList.remove('active');
      window.onclick = (e) => { if (e.target === modal || e.target === document.getElementById('editTextModal')) modal.classList.remove('active'); };

      function clearProductForm() {
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productDesc').value = '';
        document.getElementById('productType').value = 'normal';
        document.getElementById('productImageUrl').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imageUpload').querySelector('p').textContent = 'Haz clic para subir imagen';
      }

      // === SUBIDA DE IMAGEN ===
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const imageUrlInput = document.getElementById('productImageUrl');

      document.getElementById('imageUpload').onclick = () => imageInput.click();
      imageInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        imagePreview.src = URL.createObjectURL(file);
        imagePreview.style.display = 'block';
        try {
          const ref = storage.ref(`productos/${Date.now()}_${file.name}`);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          imageUrlInput.value = url;
        } catch (err) { alert('Error al subir imagen'); }
      };

      // === EDITAR PRODUCTO ===
      window.editProduct = async (id) => {
        currentProductId = id;
        document.getElementById('modalTitle').textContent = 'Editar Producto';
        try {
          const doc = await db.collection('productos').doc(id).get();
          if (doc.exists) {
            const p = doc.data();
            document.getElementById('productName').value = p.nombre || '';
            document.getElementById('productPrice').value = p.precio || '';
            document.getElementById('productDesc').value = p.descripcion || '';
            document.getElementById('productType').value = p.tipo || 'normal';
            document.getElementById('productImageUrl').value = p.imagen || '';
            if (p.imagen) {
              imagePreview.src = p.imagen;
              imagePreview.style.display = 'block';
            } else {
              imagePreview.style.display = 'none';
            }
            modal.classList.add('active');
          }
        } catch (e) { alert('Error al cargar producto'); }
      };

      // === GUARDAR PRODUCTO ===
      document.getElementById('saveProductBtn').onclick = async () => {
        const nombre = document.getElementById('productName').value.trim();
        const precio = parseFloat(document.getElementById('productPrice').value);
        const descripcion = document.getElementById('productDesc').value.trim();
        const tipo = document.getElementById('productType').value;
        const imagen = document.getElementById('productImageUrl').value.trim();

        if (!nombre || isNaN(precio) || !imagen) {
          alert('Completa nombre, precio e imagen');
          return;
        }

        const precioFormateado = `$${precio.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
        const data = { nombre, precio, precioFormateado, descripcion, tipo, imagen, habilitado: true, fecha: firebase.firestore.FieldValue.serverTimestamp() };

        try {
          if (currentProductId) {
            await db.collection('productos').doc(currentProductId).update(data);
            alert('Producto actualizado');
          } else {
            await db.collection('productos').add(data);
            alert('Producto agregado');
          }
          modal.classList.remove('active');
          location.reload(); // Recarga suave para reubicar por tipo
        } catch (e) {
          alert('Error al guardar');
        }
      };

      // === ELIMINAR PRODUCTO ===
      window.deleteProduct = async (id) => {
        if (confirm('¿Eliminar este producto?')) {
          try {
            await db.collection('productos').doc(id).delete();
            location.reload();
          } catch (e) {
            alert('Error al eliminar');
          }
        }
      };

      // === MENÚ DESPLEGABLE ===
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsMenu = document.getElementById('settingsMenu');
      settingsBtn.onclick = (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle('active');
      };
      document.addEventListener('click', () => settingsMenu.classList.remove('active'));

      // === MANTENIMIENTO ===
      const maintenanceToggle = document.getElementById('maintenanceToggle');
      const banner = document.getElementById('maintenanceBanner');
      maintenanceToggle.checked = localStorage.getItem('maintenance') !== 'true';
      maintenanceToggle.onchange = () => {
        const isOn = maintenanceToggle.checked;
        localStorage.setItem('maintenance', !isOn);
        banner.classList.toggle('show', !isOn);
      };
      if (localStorage.getItem('maintenance') === 'true') banner.classList.add('show');

      // === CERRAR SESIÓN ===
      document.getElementById('logoutBtn').onclick = () => {
        localStorage.removeItem('isAdmin');
        localStorage.removeItem('loggedIn');
        window.location.href = 'index.html';
      };
    }
  </script>
</body>
</html>
