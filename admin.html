<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Boutique Buendía</title>
<style>
  :root {
    --accent: #7c4dff;
    --bg: #fafafa;
    --card-bg: #fff;
    --text: #111;
    --muted: #666;
    --shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  body { margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text);}
  .sidebar { width:220px; position:fixed; top:0; left:0; height:100%; background:var(--card-bg); box-shadow:2px 0 10px rgba(0,0,0,0.1); padding-top:60px; display:flex; flex-direction:column; gap:12px;}
  .sidebar button { padding:12px; border:none; background:none; text-align:left; font-weight:600; cursor:pointer; transition:0.2s; }
  .sidebar button:hover { background:var(--accent); color:#fff; }
  .main { margin-left:220px; padding:20px;}
  .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .card { background:var(--card-bg); padding:16px; border-radius:10px; box-shadow:var(--shadow); margin-bottom:16px;}
  input, textarea, select, button { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
  button.btn { background:var(--accent); color:#fff; border:none; cursor:pointer; }
  button.btn.red { background:#ff6b6b; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
  img.thumb { width:80px; height:80px; object-fit:cover; border-radius:8px; }
</style>
</head>
<body>

<div class="sidebar">
  <button data-section="products">Productos</button>
  <button data-section="stats">Estadísticas</button>
  <button data-section="users">Usuarios</button>
  <button data-section="settings">Configuración</button>
  <button id="logoutBtn" class="red">Cerrar sesión</button>
</div>

<div class="main">
  <div class="topbar">
    <h2 id="sectionTitle">Productos</h2>
    <div id="adminWelcome"></div>
  </div>

  <!-- Panel Productos -->
  <div id="panelProducts" class="panel">
    <div class="card">
      <h3 id="formTitle">Agregar producto</h3>
      <input id="pNombre" placeholder="Nombre del producto">
      <textarea id="pDescripcion" rows="2" placeholder="Descripción breve"></textarea>
      <input id="pPrecio" type="number" placeholder="Precio">
      <input id="pFile" type="file" accept="image/*">
      <input id="pURL" placeholder="URL de imagen">
      <select id="pCategoria">
        <option value="">Selecciona categoría</option>
        <option value="gorras">Gorras</option>
        <option value="camisetas">Camisetas</option>
        <option value="cintos">Cintos</option>
        <option value="pantalones">Pantalones</option>
        <option value="tenis">Tenis</option>
        <option value="sudaderas">Sudaderas</option>
      </select>
      <div style="display:flex; gap:12px;">
        <button id="btnSave" class="btn">Guardar</button>
        <button id="btnClear" class="btn" style="background:#999">Limpiar</button>
      </div>
    </div>
    <div class="card">
      <h3>Productos existentes</h3>
      <table id="productsTable">
        <thead><tr><th>Imagen</th><th>Nombre</th><th>Precio</th><th>Categoría</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Estadísticas -->
  <div id="panelStats" class="panel" style="display:none;">
    <div class="card">
      <h3>Estadísticas generales</h3>
      <p>Total de productos: <span id="statProducts">0</span></p>
      <p>Total de usuarios: <span id="statUsers">0</span></p>
      <p>Total de compras: <span id="statSales">0</span></p>
    </div>
  </div>

  <!-- Panel Usuarios -->
  <div id="panelUsers" class="panel" style="display:none;">
    <div class="card">
      <h3>Usuarios registrados</h3>
      <table id="usersTable">
        <thead><tr><th>Email</th><th>UID</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Configuración -->
  <div id="panelSettings" class="panel" style="display:none;">
    <div class="card">
      <h3>Configuración de la tienda</h3>
      <input id="shopName" placeholder="Nombre de la tienda">
      <label><input type="checkbox" id="enablePage" checked> Habilitar página</label>
      <label><input type="checkbox" id="enablePaypal" checked> Habilitar PayPal</label>
      <label><input type="checkbox" id="enableCard" checked> Habilitar tarjeta</label>
      <label><input type="checkbox" id="enableOxxo" checked> Habilitar OXXO</label>
      <button id="saveSettings" class="btn">Guardar configuración</button>
    </div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBi49isj_vzkCzIyJLxsAQ_4n3_zMu4txs",
  authDomain: "buendiashop-f3dcc.firebaseapp.com",
  projectId: "buendiashop-f3dcc",
  storageBucket: "buendiashop-f3dcc.appspot.com",
  messagingSenderId: "181970112547",
  appId: "1:181970112547:web:5b5372bdb58033ba5e6196",
  measurementId: "G-MKP6G4V2KW"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Refs
const panels = {
  products: document.getElementById('panelProducts'),
  stats: document.getElementById('panelStats'),
  users: document.getElementById('panelUsers'),
  settings: document.getElementById('panelSettings')
};
const sectionTitle = document.getElementById('sectionTitle');
const adminWelcome = document.getElementById('adminWelcome');
const logoutBtn = document.getElementById('logoutBtn');

// Product refs
const pNombre = document.getElementById('pNombre');
const pDescripcion = document.getElementById('pDescripcion');
const pPrecio = document.getElementById('pPrecio');
const pFile = document.getElementById('pFile');
const pURL = document.getElementById('pURL');
const pCategoria = document.getElementById('pCategoria');
const btnSave = document.getElementById('btnSave');
const btnClear = document.getElementById('btnClear');
const productsTableBody = document.querySelector('#productsTable tbody');

let editingId = null;

// Sidebar navigation
document.querySelectorAll('.sidebar button[data-section]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const section = btn.dataset.section;
    for(const key in panels) panels[key].style.display = 'none';
    panels[section].style.display = 'block';
    sectionTitle.textContent = section.charAt(0).toUpperCase()+section.slice(1);
  });
});

// Logout
logoutBtn.addEventListener('click', async ()=>{
  await auth.signOut();
  location.href = 'login.html';
});

// Auth state
auth.onAuthStateChanged(user=>{
  if(!user) {
    location.href = 'login.html';
    return;
  }
  adminWelcome.textContent = 'Admin: ' + user.email;
  loadProducts();
  updateStats();
});

// Upload image
async function uploadImage(file){
  const name = Date.now()+'_'+file.name;
  const ref = storage.ref('productos/'+name);
  await ref.put(file);
  return await ref.getDownloadURL();
}

// Save product
btnSave.addEventListener('click', async ()=>{
  const nombre = pNombre.value.trim();
  const descripcion = pDescripcion.value.trim();
  const precio = Number(pPrecio.value);
  const categoria = pCategoria.value;
  const file = pFile.files[0];
  const urlManual = pURL.value.trim();

  if(!nombre || !precio || !categoria || (!file && !urlManual)){
    alert('Completa todos los campos e imagen.');
    return;
  }

  let finalUrl = urlManual || '';
  if(file) finalUrl = await uploadImage(file);

  const payload = { nombre, descripcion, precio, categoria, imagen: finalUrl, createdAt: firebase.firestore.FieldValue.serverTimestamp() };

  if(editingId){
    await db.collection('productos').doc(editingId).update(payload);
    editingId=null;
  } else {
    await db.collection('productos').add(payload);
  }

  clearForm();
  loadProducts();
});

// Clear form
btnClear.addEventListener('click', clearForm);
function clearForm(){
  pNombre.value = '';
  pDescripcion.value = '';
  pPrecio.value = '';
  pFile.value = '';
  pURL.value = '';
  pCategoria.value = '';
  editingId = null;
  document.getElementById('formTitle').textContent = 'Agregar producto';
}

// Load products
async function loadProducts(){
  productsTableBody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
  const snap = await db.collection('productos').orderBy('createdAt','desc').get();
  productsTableBody.innerHTML = '';
  snap.forEach(doc=>{
    const p = doc.data();
    const id = doc.id;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${p.imagen||''}" class="thumb"></td>
      <td>${p.nombre}</td>
      <td>$${p.precio}</td>
      <td>${p.categoria}</td>
      <td>
        <button onclick="editProduct('${id}')">Editar
