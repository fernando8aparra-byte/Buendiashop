<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Efra√≠n Shop</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* --- Ajustes espec√≠ficos para las nuevas funciones --- */
    /* Keep your main styles in css/styles.css; these are enhancements */
    .welcome-badge {
      position: absolute;
      left: 18px;
      top: 70px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      display:flex;
      align-items:center;
      gap:10px;
      transform-origin: left center;
      opacity: 0;
      pointer-events: none;
      z-index: 150;
    }
    .welcome-badge.show { animation: slideInOut 4s ease forwards; }
    @keyframes slideInOut {
      0% { transform: translateX(-10px); opacity:0 }
      10% { transform: translateX(0); opacity:1 }
      70% { transform: translateX(0); opacity:1 }
      100% { transform: translateX(0); opacity:0 }
    }

    /* Carousel (infinite horizontal) */
    .carousel-wrap { margin: 18px 0; overflow:hidden; background:linear-gradient(90deg,#fff,#fafafa); padding:8px 0; border-radius:10px; }
    .carousel {
      display:flex;
      gap:12px;
      align-items:center;
      animation: scrollLeft 18s linear infinite;
    }
    .carousel .item { min-width: 220px; background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); padding:10px; display:flex; gap:10px; align-items:center; }
    .carousel img { width:64px; height:64px; object-fit:cover; border-radius:8px; }
    @keyframes scrollLeft {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } /* duplicated items for illusion */
    }

    /* Star ad strip */
    .star-ads { display:flex; gap:12px; align-items:center; overflow:auto; padding:8px 0; margin-bottom:10px; }
    .star-ads .ad { min-width: 140px; background:#fff; padding:8px; border-radius:8px; display:flex; gap:8px; align-items:center; box-shadow:0 4px 14px rgba(0,0,0,0.06); }
    .star-ads img { width:48px; height:48px; object-fit:cover; border-radius:6px; }

    /* Product grid adjustments */
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:18px; padding:10px; }
    .card img { height:140px; object-fit:cover; }
    @media (max-width:900px) { .grid { grid-template-columns: repeat(3,1fr); } }
    @media (max-width:600px) {
      .grid { grid-template-columns: repeat(2,1fr); gap:12px; }
      .card img { height:120px; }
      header .logo { font-size:18px; }
      .header-actions #search { display:none; } /* mobile hide search input (we keep icon if you want) */
    }

    /* Cart shake animation */
    .cart-shake { animation: cartShake 1s ease; }
    @keyframes cartShake {
      0%{ transform: translateX(0) }
      20%{ transform: translateX(-6px) }
      40%{ transform: translateX(6px) }
      60%{ transform: translateX(-6px) }
      80%{ transform: translateX(6px) }
      100%{ transform: translateX(0) }
    }

    /* Mini modal (payment / data form) */
    .modal {
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.45);
      z-index:400;
    }
    .modal.open { display:flex; }
    .modal .box {
      background:#fff; padding:18px; border-radius:10px; width:92%; max-width:420px;
    }

    /* small helpers */
    .small-muted { font-size:13px; color:#666; }
  </style>
</head>
<body>

  <!-- ====== HEADER ====== -->
  <header>
    <div class="header-inner">
      <div id="menuBtn">‚ò∞</div>
      <div class="logo">Efra√≠n Shop</div>
      <div class="header-actions">
        <input type="text" id="search" placeholder="Buscar..." />
        <button class="login-btn" id="loginBtn">Iniciar sesi√≥n</button>
        <div id="cartBtn" class="icon" title="Carrito">
          <img src="https://cdn-icons-png.flaticon.com/512/833/833314.png" alt="Carrito" />
        </div>
      </div>
    </div>
  </header>

  <!-- welcome badge (subtle left, shows then fades) -->
  <div class="welcome-badge" id="welcomeBadge" aria-hidden="true">
    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="" style="width:20px;height:20px;border-radius:50%;" />
    <span id="welcomeText">Bienvenido, Usuario</span>
  </div>

  <!-- ====== MEN√ö LATERAL ====== -->
  <div class="menu-overlay"></div>
  <nav class="menu-dropdown" id="menu">
    <span class="menu-close" id="menuClose">‚úï</span>

    <div class="menu-item cuenta" id="cuentaBtn">Cuenta</div>
    <div class="submenu" id="submenuCuenta">
      <div class="menu-item" id="estadoSesion">Iniciar sesi√≥n</div>
      <div class="menu-item" id="misCompras">Mis compras</div>
    </div>

    <div class="menu-item productos">Productos ‚ñº</div>
    <div class="submenu" id="submenuProductos">
      <div class="menu-item">Gorras</div>
      <div class="menu-item">Camisetas</div>
      <div class="menu-item">Cintos</div>
      <div class="menu-item">Pantalones</div>
      <div class="menu-item">Tenis</div>
      <div class="menu-item">Sudaderas</div>
    </div>

    <div class="menu-item">Nosotros ‚ñº</div>
    <div class="submenu redes">
      <div class="menu-item">Facebook</div>
      <div class="menu-item">Instagram</div>
      <div class="menu-item">TikTok</div>
      <div class="menu-item">WhatsApp</div>
    </div>

    <div style="height:40px"></div>
    <div class="menu-item small-muted">¬© Efra√≠n Shop</div>
  </nav>

  <!-- ====== CONTENIDO ====== -->
  <main>
    <h1 class="page-title">Productos disponibles</h1>

    <!-- Optional carousel of new products (admin can enable) -->
    <div class="carousel-wrap" id="carouselWrap" aria-hidden="true">
      <div class="carousel" id="carouselInner"></div>
    </div>

    <!-- Star ads -->
    <div class="star-ads" id="starAds" aria-hidden="true"></div>

    <!-- Products grid -->
    <section class="grid" id="productsGrid"></section>
  </main>

  <!-- ====== CARRITO ====== -->
  <div class="cart-panel" id="cartPanel">
    <div class="cart-header">
      <span>Carrito</span>
      <span id="closeCart" style="cursor:pointer;">‚úï</span>
    </div>

    <div class="cart-items" id="cartItems">
      <div class="cart-empty">Tu carrito est√° vac√≠o üõçÔ∏è</div>
    </div>

    <div class="cart-footer" id="cartFooter" style="display:none;">
      <div class="cart-total" id="cartTotal">Total: $0</div>
      <div class="payment-options" id="paymentOptions">
        <button class="pay-btn" id="paypalBtn">PayPal</button>
        <button class="pay-btn" id="cardBtn">Tarjeta</button>
        <button class="pay-btn" id="oxxoBtn">Pago en Oxxo</button>
      </div>
    </div>
  </div>

  <!-- ====== TOAST ====== -->
  <div class="toast" id="toast" role="status" aria-live="polite">Producto agregado al carrito</div>

  <!-- ====== MODAL (datos de pago / direcci√≥n) -->
  <div class="modal" id="modal">
    <div class="box" id="modalBox">
      <h3 id="modalTitle">Formulario</h3>
      <p class="small-muted">Esto es un ejemplo de formulario. Aqu√≠ se recoge datos personales para procesar el pago.</p>
      <input id="fullName" placeholder="Nombre completo" style="width:100%;padding:8px;margin:8px 0;border-radius:6px;border:1px solid #ccc;">
      <input id="phone" placeholder="Tel√©fono" style="width:100%;padding:8px;margin:8px 0;border-radius:6px;border:1px solid #ccc;">
      <input id="address" placeholder="Direcci√≥n" style="width:100%;padding:8px;margin:8px 0;border-radius:6px;border:1px solid #ccc;">
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
        <button id="cancelModal" style="padding:8px 12px;border-radius:6px;">Cancelar</button>
        <button id="submitModal" style="padding:8px 12px;background:#00b894;color:white;border-radius:6px;">Enviar</button>
      </div>
    </div>
  </div>

  <!-- ====== SCRIPTS ====== -->
  <script type="module">
  // ---------- Firebase (se utiliza opcionalmente para admin/config) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
    authDomain: "boutique-buendia.firebaseapp.com",
    projectId: "boutique-buendia",
    storageBucket: "boutique-buendia.firebasestorage.app",
    messagingSenderId: "430651152709",
    appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c",
    measurementId: "G-9KJ2330RN7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");
  const menuClose = document.getElementById("menuClose");
  const cuentaBtn = document.getElementById("cuentaBtn");
  const submenuCuenta = document.getElementById("submenuCuenta");
  const productosBtn = document.querySelector(".productos");
  const submenuProductos = document.getElementById("submenuProductos");
  const nosotrosBtn = document.querySelector(".menu-item:nth-of-type(9)"); // best-effort
  const submenuNosotros = document.querySelector(".redes");

  const searchInput = document.getElementById("search");
  const productsGrid = document.getElementById("productsGrid");
  const cartBtn = document.getElementById("cartBtn");
  const cartPanel = document.getElementById("cartPanel");
  const cartItemsEl = document.getElementById("cartItems");
  const cartFooter = document.getElementById("cartFooter");
  const cartTotalEl = document.getElementById("cartTotal");
  const toast = document.getElementById("toast");
  const carouselInner = document.getElementById("carouselInner");
  const carouselWrap = document.getElementById("carouselWrap");
  const starAdsEl = document.getElementById("starAds");
  const welcomeBadge = document.getElementById("welcomeBadge");
  const welcomeText = document.getElementById("welcomeText");
  const estadoSesion = document.getElementById("estadoSesion");
  const loginBtn = document.getElementById("loginBtn");

  // Modal
  const modal = document.getElementById("modal");
  const cancelModal = document.getElementById("cancelModal");
  const submitModal = document.getElementById("submitModal");

  // ---------- Data: products stored in localStorage ----------
  const SAMPLE_PRODUCTS = [
    { id: 'p1', sku:'G-001', nombre: 'Gorra Barbas Hats', descripcion:'Gorra con logo bordado', precio:120, stock:5, categoria:'Gorras', img:'https://images.unsplash.com/photo-1520975918143-3a0c87a1e0b7?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=75f8f0bdea6b0af2a2a7a0f8a8b5a8e3', talla: [] , estrella: true },
    { id: 'p2', sku:'C-101', nombre: 'Camiseta Oversize Negra', descripcion:'Camiseta oversize algod√≥n 100%', precio:220, stock:12, categoria:'Camisetas', img:'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=4f0e1f6c7a0ecf3ee2b8b2f9f6f6e8b2', talla:['S','M','L','XL'], estrella:false },
    { id: 'p3', sku:'T-010', nombre: 'Tenis Runner Pro', descripcion:'Tenis deportivos para correr', precio:1350, stock:4, categoria:'Tenis', img:'https://images.unsplash.com/photo-1528701800489-2c34b0a2f8e3?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=7a3c2b1d3e5f6a7b8c9d0e1f2a3b4c5d', talla:['40','41','42','43'], estrella:true },
    { id: 'p4', sku:'P-030', nombre: 'Pantal√≥n Cargo Verde', descripcion:'Pantal√≥n cargo resistente', precio:450, stock:8, categoria:'Pantalones', img:'https://images.unsplash.com/photo-1578894386599-1b073cbd3d14?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=abcd1234abcd1234abcd1234abcd1234', talla:['M','L','XL'], estrella:false },
    { id: 'p5', sku:'S-201', nombre: 'Sudadera Logo', descripcion:'Sudadera con capucha y logo', precio:580, stock:7, categoria:'Sudaderas', img:'https://images.unsplash.com/photo-1520975918143-3a0c87a1e0b7?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=75f8f0bdea6b0af2a2a7a0f8a8b5a8e3', talla:['S','M','L'], estrella:false }
  ];

  function getStoredProducts(){
    const raw = localStorage.getItem('productos');
    if(!raw) {
      localStorage.setItem('productos', JSON.stringify(SAMPLE_PRODUCTS));
      return SAMPLE_PRODUCTS.slice();
    }
    try { return JSON.parse(raw); } catch(e){ localStorage.setItem('productos', JSON.stringify(SAMPLE_PRODUCTS)); return SAMPLE_PRODUCTS.slice(); }
  }

  // Cart stored in localStorage 'cart'
  function getCart(){ return JSON.parse(localStorage.getItem('cart')||'[]'); }
  function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }

  // ---------- Render products ----------
  function renderProducts(list){
    productsGrid.innerHTML = '';
    if(!list.length){
      productsGrid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#777">No hay productos que coincidan</p>';
      return;
    }
    list.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${p.img}" alt="${p.nombre}">
        <div class="meta">
          <div class="title">${p.nombre}</div>
          <div class="price">$${p.precio}</div>
          <div class="small-muted">${p.categoria} ‚Ä¢ Stock ${p.stock}</div>
          <div style="margin-top:8px;display:flex;gap:8px;">
            <button class="addBtn" data-id="${p.id}">Agregar</button>
            <button class="viewBtn" data-id="${p.id}">Ver</button>
          </div>
        </div>
      `;
      productsGrid.appendChild(card);
    });
  }

  // ---------- Load carousel & star ads ----------
  function setupCarousel(products){
    // Duplicate list to create infinite feeling
    const items = products.filter(p=>p.estrella).concat(products.filter(p=>p.estrella));
    if(!items.length){ carouselWrap.style.display='none'; return; }
    carouselInner.innerHTML = '';
    items.forEach(p=>{
      const it = document.createElement('div');
      it.className = 'item';
      it.innerHTML = `<img src="${p.img}" alt=""><div><strong>${p.nombre}</strong><div class="small-muted">$${p.precio}</div></div>`;
      carouselInner.appendChild(it);
    });
  }

  function setupStarAds(products){
    const ads = products.filter(p=>p.estrella);
    if(!ads.length){ starAdsEl.style.display='none'; return; }
    starAdsEl.innerHTML = '';
    ads.forEach(p=>{
      const a = document.createElement('div');
      a.className='ad';
      a.innerHTML = `<img src="${p.img}" alt=""><div><strong style="font-size:14px">${p.nombre}</strong><div class="small-muted">$${p.precio}</div></div>`;
      a.addEventListener('click', ()=> openProduct(p.id));
      starAdsEl.appendChild(a);
    });
  }

  // ---------- Search ----------
  function searchProducts(q){
    q = q.trim().toLowerCase();
    const products = getStoredProducts();
    if(!q) return products;
    // split words and find if any word in name or description
    const tokens = q.split(/\s+/).filter(Boolean);
    return products.filter(p=>{
      const hay = (p.nombre + ' ' + (p.descripcion||'') ).toLowerCase();
      // must match all tokens OR any token? We'll match any token presence to be flexible
      return tokens.every(tok => hay.includes(tok)); // require all tokens
    });
  }

  // ---------- Cart UI ----------
  function renderCart(){
    const cart = getCart();
    cartItemsEl.innerHTML = '';
    if(!cart.length){
      cartItemsEl.innerHTML = '<div class="cart-empty">Tu carrito est√° vac√≠o üõçÔ∏è</div>';
      cartFooter.style.display = 'none';
      return;
    }
    cartFooter.style.display = 'block';
    cart.forEach(item=>{
      const p = getStoredProducts().find(x=>x.id===item.id);
      const div = document.createElement('div');
      div.style.display='flex';
      div.style.gap='10px';
      div.style.alignItems='center';
      div.style.marginBottom='10px';
      div.innerHTML = `<img src="${p.img}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;"><div style="flex:1"><div style="font-weight:700">${p.nombre}</div><div class="small-muted">x${item.qty}</div></div><div style="font-weight:800">$${p.precio*item.qty}</div>`;
      cartItemsEl.appendChild(div);
    });
    const total = cart.reduce((s,i)=> {
      const p = getStoredProducts().find(x=>x.id===i.id);
      return s + (p ? p.precio * i.qty : 0);
    },0);
    cartTotalEl.textContent = `Total: $${total}`;
  }

  function addToCart(id){
    const p = getStoredProducts().find(x=>x.id===id);
    if(!p) return;
    const cart = getCart();
    const idx = cart.findIndex(c=>c.id===id);
    if(idx>=0) cart[idx].qty += 1; else cart.push({id, qty:1});
    saveCart(cart);
    // cart shake
    cartBtn.classList.add('cart-shake');
    setTimeout(()=>cartBtn.classList.remove('cart-shake'), 1000);
    // show toast
    showToast('Agregado al carrito', 'green');
    renderCart();
  }

  // ---------- Toast ----------
  let toastTimer;
  function showToast(text, color='green'){
    toast.textContent = text;
    toast.style.background = color==='green' ? 'var(--accent, #7c4dff)' : '#e53935';
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 2000);
  }

  // ---------- Product view / open product page ----------
  function openProduct(id){
    // For now open product.html?id=...
    window.location.href = `product.html?id=${id}`;
  }

  // ---------- Modal (payment form) ----------
  function openModal(title){
    document.getElementById('modalTitle').textContent = title;
    modal.classList.add('open');
  }
  cancelModal.addEventListener('click', ()=> modal.classList.remove('open'));
  submitModal.addEventListener('click', ()=>{
    // just simulate success
    modal.classList.remove('open');
    showToast('Datos enviados. Procediendo al pago', 'green');
  });

  // ---------- Menu interactions ----------
  menuBtn.onclick = ()=> menu.classList.add('open');
  menuClose.onclick = ()=> menu.classList.remove('open');
  cuentaBtn.onclick = ()=> submenuCuenta.classList.toggle('open');
  productosBtn && (productosBtn.onclick = ()=> submenuProductos.classList.toggle('open'));
  // nosotrosBtn maybe undefined; handled safely
  if(nosotrosBtn) nosotrosBtn.onclick = ()=> submenuNosotros.classList.toggle('open');

  // Cart open/close
  cartBtn.onclick = ()=> cartPanel.classList.toggle('open');
  document.getElementById('closeCart').onclick = ()=> cartPanel.classList.remove('open');

  // ---------- Search event ----------
  searchInput.addEventListener('input', (e)=>{
    const results = searchProducts(e.target.value);
    renderProducts(results);
  });

  // ---------- Product buttons handler (event delegation) ----------
  productsGrid.addEventListener('click', (ev)=>{
    const add = ev.target.closest('.addBtn');
    const view = ev.target.closest('.viewBtn');
    if(add){ addToCart(add.dataset.id); return; }
    if(view){ openProduct(view.dataset.id); return; }
  });

  // Payment buttons
  document.getElementById('paypalBtn').addEventListener('click', ()=> openModal('Pago con PayPal'));
  document.getElementById('cardBtn').addEventListener('click', ()=> openModal('Pago con tarjeta'));
  document.getElementById('oxxoBtn').addEventListener('click', ()=> openModal('Pago en Oxxo'));

  // Estado sesi√≥n (Cuenta submenu)
  const usuarioActivo = localStorage.getItem('usuarioActivo');
  function updateSessionUI(){
    const estado = document.getElementById('estadoSesion');
    if(usuarioActivo){
      estado.textContent = 'Cerrar sesi√≥n';
      loginBtn.textContent = `Bienvenido, ${usuarioActivo}`;
    } else {
      estado.textContent = 'Iniciar sesi√≥n';
      loginBtn.textContent = 'Iniciar sesi√≥n';
    }
  }
  updateSessionUI();
  estadoSesion.addEventListener('click', ()=>{
    const act = localStorage.getItem('usuarioActivo');
    if(act){
      localStorage.removeItem('usuarioActivo');
      alert('Sesi√≥n cerrada');
      location.reload();
    } else {
      window.location.href = 'login.html';
    }
  });
  loginBtn.addEventListener('click', ()=> {
    if(localStorage.getItem('usuarioActivo')) alert('Ya tienes sesi√≥n iniciada');
    else window.location.href = 'login.html';
  });

  // ---------- Init: load products and render ----------
  const products = getStoredProducts();
  renderProducts(products);
  setupCarousel(products);
  setupStarAds(products);
  renderCart();

  // ---------- Optional: load admin config from Firestore (enable/disable features) ----------
  // If you want admin to control which animations are shown, which payments are enabled, etc.
  // create a doc 'config/main' in Firestore with fields like { carouselEnabled:true, starAdsEnabled:true, payments: { paypal:true, card:true, oxxo:false } }
  (async function loadConfig(){
    try {
      const cfgRef = doc(db, 'config', 'main');
      const snap = await getDoc(cfgRef);
      if(!snap.exists()) return;
      const cfg = snap.data();
      if(cfg.carouselEnabled === false) carouselWrap.style.display = 'none';
      if(cfg.starAdsEnabled === false) starAdsEl.style.display = 'none';
      if(cfg.payments){
        if(!cfg.payments.paypal) document.getElementById('paypalBtn').style.display='none';
        if(!cfg.payments.card) document.getElementById('cardBtn').style.display='none';
        if(!cfg.payments.oxxo) document.getElementById('oxxoBtn').style.display='none';
      }
    } catch(e){
      // ignore if no config or permission error
      // console.log('config load error', e);
    }
  })();

  // ---------- Accessibility: keyboard close menu with Esc ----------
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ menu.classList.remove('open'); cartPanel.classList.remove('open'); modal.classList.remove('open'); } });

  </script>
</body>
</html>
