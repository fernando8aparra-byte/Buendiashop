<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas - Boutique Buendía</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { margin: 0; padding: 0; background: #f8f8f8; font-family: 'Poppins', sans-serif; }
    .header {
      background: #000; color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 1000; font-weight: 800; font-size: 1.4rem; text-transform: uppercase;
    }
    .header .left { display: flex; align-items: center; gap: 12px; }
    .header .back { font-size: 1.7rem; cursor: pointer; }
    .header .brand { font-size: 1.05rem; font-weight: 800; letter-spacing: 1px; }
    .header .title { flex: 1; text-align: center; margin-right: -50px; }
    .header .settings { font-size: 1.6rem; cursor: pointer; position: relative; }

    .settings-menu {
      display: none; position: absolute; right: 0; top: 60px; background: #000; color: #fff;
      border-radius: 10px; width: 220px; z-index: 999; box-shadow: 0 5px 15px rgba(0,0,0,0.6);
    }
    .settings-menu.show { display: block; }
    .settings-menu button {
      width: 100%; padding: 14px 16px; text-align: left; background: none; border: none;
      color: #fff; font-family: 'Poppins', sans-serif; font-size: 0.95rem; cursor: pointer;
      border-bottom: 1px solid #333;
    }
    .settings-menu button:hover { background: #222; }
    .settings-menu button:last-child { border-bottom: none; }

    .controls { padding: 15px 20px; background: #fff; display: flex; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .search-box, .sort-box { padding: 10px 14px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 0.95rem; }
    .search-box { flex: 1; min-width: 200px; }
    .sort-box { width: 160px; }

    .orders-container { padding: 20px; overflow-y: auto; max-height: calc(100vh - 180px); }
    .order-card {
      background: #fff; border-radius: 12px; padding: 18px; margin-bottom: 16px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08); position: relative;
    }
    .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .order-id { font-weight: 800; font-size: 1.3rem; color: #000; }
    .order-date { font-size: 0.9rem; color: #666; }
    .info-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; font-size: 0.95rem; line-height: 1.5;
    }
    .info-grid strong { color: #000; }
    .total { font-size: 1.3rem; font-weight: 800; color: #000; margin-top: 10px; text-align: right; }
    .print-btn {
      position: absolute; top: 18px; right: 18px; background: #000; color: #fff;
      border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    .print-btn i { margin-right: 6px; }

    .empty { text-align: center; padding: 60px 20px; color: #666; font-size: 1.1rem; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="left">
      <div class="back" onclick="window.location.href='admin.html'">←</div>
      <div class="brand">BOUTIQUE BUENDÍA</div>
    </div>
    <div class="title">VENTAS</div>
    <div class="settings" id="settingsBtn">⚙️
      <div class="settings-menu" id="settingsMenu">
        <button onclick="filterOrders('paid')">Pedidos Pagados</button>
        <button onclick="filterOrders('pending')">Pedidos Pendientes</button>
        <button onclick="filterOrders('all')">Todos los Pedidos</button>
        <button onclick="showCourierMap()">Encontrar Paquetería</button>
      </div>
    </div>
  </div>

  <!-- CONTROLES -->
  <div class="controls">
    <input type="text" class="search-box" id="searchInput" placeholder="Buscar por nombre, teléfono, CP, orden...">
    <select class="sort-box" id="sortSelect">
      <option value="date-desc">Más reciente</option>
      <option value="date-asc">Más antiguo</option>
      <option value="total-desc">Mayor total</option>
      <option value="total-asc">Menor total</option>
    </select>
  </div>

  <!-- PEDIDOS -->
  <div class="orders-container" id="ordersContainer">
    <div class="empty">Cargando pedidos pagados...</div>
  </div>

  <!-- MODAL MAPA -->
  <div class="modal" id="courierModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2000;justify-content:center;align-items:center;">
    <div style="background:#fff;padding:20px;border-radius:12px;max-width:90%;text-align:center;">
      <h3>Paqueterías en Navojoa, Sonora</h3>
      <div id="map" style="height:400px;width:100%;margin:15px 0;border-radius:10px;"></div>
      <button style="padding:12px 24px;background:#000;color:#fff;border:none;border-radius:8px;cursor:pointer;" 
              onclick="document.getElementById('courierModal').style.display='none'">Cerrar</button>
    </div>
  </div>

  <!-- Firebase + Lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
      authDomain: "boutique-buendia.firebaseapp.com",
      projectId: "boutique-buendia",
      storageBucket: "boutique-buendia.firebasestorage.app",
      messagingSenderId: "430651152709",
      appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ordersContainer = document.getElementById('ordersContainer');
    let allOrders = [];
    let currentFilter = 'paid'; // Por defecto solo pagados

    async function loadOrders() {
      ordersContainer.innerHTML = '<div class="empty">Cargando pedidos pagados...</div>';
      const q = query(collection(db, "orders"), orderBy("date", "desc"));
      const snapshot = await getDocs(q);
      allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      filterOrders(currentFilter);
    }

    function renderOrders(orders) {
      if (orders.length === 0) {
        ordersContainer.innerHTML = `<div class="empty">No hay pedidos ${currentFilter === 'paid' ? 'pagados' : currentFilter === 'pending' ? 'pendientes' : ''}.</div>`;
        return;
      }

      ordersContainer.innerHTML = orders.map(order => {
        const date = order.date?.toDate?.() || new Date(order.date);
        const formattedDate = date.toLocaleDateString('es-MX') + ' ' + date.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
        const a = order.address || {};
        const orderId = order.paymentId || order.id;

        return `
          <div class="order-card">
            <div class="order-header">
              <div class="order-id">#${orderId}</div>
              <div class="order-date">${formattedDate}</div>
            </div>
            <div class="info-grid">
              <div><strong>Nombre:</strong> ${a.name || 'Sin nombre'}</div>
              <div><strong>Teléfono:</strong> ${a.phone || 'Sin teléfono'}</div>
              <div><strong>Domicilio:</strong> ${a.street || ''}, ${a.colonia || ''}</div>
              <div><strong>C.P.:</strong> ${a.cp || '00000'}</div>
              <div><strong>Estado:</strong> ${a.state || 'Sonora'}</div>
              <div><strong>Total:</strong> $${(order.total || 0).toLocaleString()} MXN</div>
            </div>
            <div class="total">TOTAL: $${(order.total || 0).toLocaleString()} MXN</div>
            <button class="print-btn" onclick="printLabel('${order.id}')">
              <i class="fas fa-print"></i> Imprimir Etiqueta
            </button>
          </div>
        `;
      }).join('');
    }

    // Etiqueta de envío profesional (4x6 in)
    window.printLabel = function(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return alert("Error: pedido no encontrado");

      const a = order.address || {};
      const orderNum = order.paymentId || order.id;

      const win = window.open('', '', 'width=600,height=900');
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Etiqueta #${orderNum}</title>
          <style>
            body { font-family: 'Arial', sans-serif; margin: 0; padding: 15px; }
            .label { width: 4in; height: 6in; border: 5px solid #000; padding: 20px; box-sizing: border-box; background: white; }
            .header { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 20px; }
            .order-num { font-size: 48px; font-weight: bold; text-align: center; background: #000; color: white; padding: 15px; margin: 20px 0; }
            .section { margin: 25px 0; font-size: 22px; line-height: 1.6; }
            .title { font-weight: bold; text-decoration: underline; margin-bottom: 10px; font-size: 24px; }
            .barcode { font-size: 50px; text-align: center; margin: 30px 0; letter-spacing: 10px; font-weight: bold; }
            @media print { body { margin:0; padding:10px; } .no-print { display:none; } }
          </style>
        </head>
        <body>
          <div class="label">
            <div class="header">BOUTIQUE BUENDÍA</div>
            <div class="order-num">#${orderNum}</div>
            <div class="section">
              <div class="title">ENVIAR A:</div>
              <strong>${a.name || 'N/A'}</strong><br>
              ${a.phone || 'Sin teléfono'}<br><br>
              ${a.street || ''}<br>
              ${a.colonia || ''}<br>
              C.P. ${a.cp || '00000'}, ${a.state || 'Sonora'}<br>
              Navojoa, Sonora, México
            </div>
            <div class="section">
              <div class="title">DETALLES:</div>
              Total: <strong>$${(order.total || 0).toLocaleString()} MXN</strong><br>
              Fecha: ${new Date(order.date?.toDate() || order.date).toLocaleDateString('es-MX')}
            </div>
            <div class="barcode">${orderNum}</div>
          </div>
          <button class="no-print" onclick="window.print()" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:15px 30px;font-size:18px;background:#000;color:white;border:none;border-radius:8px;cursor:pointer;">
            Imprimir Etiqueta
          </button>
        </body>
        </html>
      `);
      win.document.close();
    };

    // Filtros
    window.filterOrders = function(status) {
      currentFilter = status;
      document.getElementById('settingsMenu').classList.remove('show');
      let filtered = allOrders;

      if (status === 'paid') filtered = allOrders.filter(o => o.status === 'paid');
      else if (status === 'pending') filtered = allOrders.filter(o => o.status !== 'paid');
      // 'all' muestra todos

      // Aplicar búsqueda
      const search = document.getElementById('searchInput').value.toLowerCase();
      if (search) {
        filtered = filtered.filter(o => {
          const a = o.address || {};
          return `${o.paymentId || o.id} ${a.name} ${a.phone} ${a.cp} ${a.street}`.toLowerCase().includes(search);
        });
      }

      // Ordenar
      const sort = document.getElementById('sortSelect').value;
      filtered.sort((a, b) => {
        const da = a.date?.toDate?.() || a.date;
        const db = b.date?.toDate?.() || b.date;
        if (sort === 'date-desc') return db - da;
        if (sort === 'date-asc') return da - db;
        if (sort === 'total-desc') return (b.total || 0) - (a.total || 0);
        if (sort === 'total-asc') return (a.total || 0) - (b.total || 0);
        return 0;
      });

      renderOrders(filtered);
    };

    // Búsqueda en tiempo real
    document.getElementById('searchInput').addEventListener('input', () => filterOrders(currentFilter));
    document.getElementById('sortSelect').addEventListener('change', () => filterOrders(currentFilter));

    // Menú
    document.getElementById('settingsBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('settingsMenu').classList.toggle('show');
    });
    document.addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.remove('show');
    });

    // Mapa
    window.showCourierMap = () => {
      document.getElementById('courierModal').style.display = 'flex';
      if (!window.mapLoaded) {
        window.mapLoaded = true;
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQUI&libraries=places&callback=initMap';
        document.body.appendChild(script);
      } else if (window.initMap) initMap();
    };

    window.initMap = function() {
      const navojoa = { lat: 27.0727, lng: -109.4437 };
      const map = new google.maps.Map(document.getElementById("map"), { zoom: 14, center: navojoa });
      const service = new google.maps.places.PlacesService(map);
      service.textSearch({ location: navojoa, radius: 10000, query: "paquetería DHL FedEx Estafeta Navojoa" }, (results, status) => {
        if (status === 'OK') results.forEach(r => r.geometry && new google.maps.Marker({ map, position: r.geometry.location, title: r.name }));
      });
    };

    // Cargar al iniciar
    loadOrders();
  </script>
</body>
</html>
