<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compras - Efraín Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:#f8f8f8;padding-top:60px}
    .header{position:fixed;top:0;left:0;width:100%;z-index:1000;background:#000;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;height:60px;padding:0 15px}
    .header-left{display:flex;align-items:center;gap:15px}
    .header-center{flex:1;text-align:center;font-weight:800;font-size:1.2rem;text-transform:uppercase}
    .header-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:.9rem}
    .total-compras{font-weight:bold}
    .total-ventas{color:#00cc00;font-weight:600}
    .back-btn{background:rgba(255,255,255,.15);padding:10px 14px;border-radius:10px;transition:.2s;font-weight:600;display:inline-flex;align-items:center;gap:8px;color:#fff;text-decoration:none}
    .back-btn:hover{background:rgba(255,255,255,.25);transform:translateX(-2px)}
    .back-btn svg{width:18px;height:18px;fill:#fff}
    .main-container{padding:20px 15px;max-width:900px;margin:0 auto}
    .summary-box{background:#fff;border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.05);font-size:.95rem}
    .summary-title{font-weight:800;font-size:1.1rem;margin-bottom:10px;color:#000}
    .summary-item{display:flex;justify-content:space-between;margin:6px 0}
    .summary-item strong{color:#000}
    .orders-container{margin-top:20px;max-height:calc(100vh-220px);overflow-y:auto;padding-right:5px}
    .orders-container::-webkit-scrollbar{width:6px}
    .orders-container::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .orders-container::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
    .order-card{background:#fff;border:1.5px solid #eee;border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .order-header{font-weight:800;font-size:1.1rem;margin-bottom:8px;color:#000}
    .order-id{font-size:.85rem;color:#666;margin-bottom:8px}
    .order-total{font-weight:800;font-size:1.3rem;color:#000;margin:10px 0}
    .order-products{margin:12px 0;padding:12px;background:#f9f9f9;border-radius:8px}
    .order-product{font-size:.95rem;margin:6px 0;display:flex;justify-content:space-between}
    .order-address{font-size:.9rem;color:#444;margin-top:12px;line-height:1.6}
    .order-date{font-size:.8rem;color:#888;margin-top:10px;text-align:right}
    .action-btns{display:flex;gap:8px;margin-top:12px}
    .print-btn,.send-btn,.status-btn{background:#f0f0f0;border:1px solid #ddd;cursor:pointer;padding:8px 12px;border-radius:6px;font-size:.9rem;color:#000;display:inline-flex;align-items:center;gap:6px;transition:.2s;font-weight:600;flex:1;justify-content:center}
    .print-btn:hover,.send-btn:hover,.status-btn:hover{background:#e0e0e0;border-color:#aaa}
    .print-btn svg,.send-btn svg{width:18px;height:18px;stroke:currentColor;fill:none}
    .status-btn{background:#4CAF50;color:#fff;border:none}
    .status-btn.pending{background:#FFC107;color:#000}
    .status-btn.shipped{background:#2196F3;color:#fff}
    .status-btn.delivered{background:#4CAF50;color:#fff}
    .status-btn.cancelled{background:#f44336;color:#fff}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:12px 24px;border-radius:8px;z-index:3000;opacity:0;transition:opacity .3s;font-weight:600}
    .toast.show{opacity:1}
    .sort-btn{background:#fff;border:1px solid #ddd;padding:8px 12px;border-radius:6px;font-size:.9rem;display:flex;align-items:center;gap:6px;cursor:pointer;transition:.2s}
    .sort-btn:hover{background:#f0f0f0}
    .sort-btn svg{width:16px;height:16px;stroke:currentColor;fill:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media print{
      body *{visibility:hidden}
      .printable-order,.printable-order *{visibility:visible}
      .printable-order{position:absolute;left:0;top:0;width:100%;padding:20px;background:white}
      .action-btns,.header,.sort-btn,.toast,.summary-box{display:none!important}
      .order-address strong{display:inline-block;width:130px;font-weight:600}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner">
      <div class="header-left">
        <a href="index.html" class="back-btn">
          <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/></svg>
          Regresar
        </a>
      </div>
      <div class="header-center">COMPRAS</div>
      <div class="header-right">
        <div class="total-compras" id="totalCompras">Total: 0</div>
        <div class="total-ventas" id="totalVentas">Total Ventas: $0.00</div>
      </div>
    </div>
  </header>

  <main class="main-container">
    <div style="position:relative; margin-bottom:20px;">
      <button class="sort-btn" id="sortBtn">
        <svg viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z" fill="currentColor"/></svg>
        Ordenar por fecha
      </button>
    </div>

    <div class="summary-box">
      <div class="summary-title">Resumen de Productos Vendidos</div>
      <div id="productsSummary">Cargando...</div>
    </div>

    <div class="orders-container" id="ordersContainer">
      <div style="text-align:center;color:#666;padding:30px;">
        <div style="display:inline-block;width:30px;height:30px;border:3px solid #f3f3f3;border-top:3px solid #000;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px;"></div>
        <div>Cargando compras...</div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, doc, updateDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
      authDomain: "boutique-buendia.firebaseapp.com",
      projectId: "boutique-buendia",
      storageBucket: "boutique-buendia.firebasestorage.app",
      messagingSenderId: "430651152709",
      appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ordersContainer = document.getElementById('ordersContainer');
    const productsSummary = document.getElementById('productsSummary');
    const totalComprasEl = document.getElementById('totalCompras');
    const totalVentasEl = document.getElementById('totalVentas');
    const toast = document.getElementById('toast');

    // === CARGAR ÓRDENES DESDE FIRESTORE (API MODERNA) ===
    async function loadOrders() {
      try {
        const q = query(collection(db, 'orders'), orderBy('date', 'desc'));
        const snapshot = await getDocs(q);

        let totalVentas = 0;
        let totalOrdenes = 0;
        const productMap = {};
        let ordersHTML = '';

        if (snapshot.empty) {
          ordersHTML = '<div style="text-align:center;color:#666;padding:30px;">No hay compras aún.</div>';
        } else {
          totalOrdenes = snapshot.size;
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            const monto = Number(data.total) || 0;
            totalVentas += monto;

            // Sumar productos
            (data.products || []).forEach(p => {
              const name = p.name || 'Sin nombre';
              const qty = Number(p.qty) || 1;
              const price = Number(p.price) || 0;
              if (!productMap[name]) productMap[name] = { qty: 0, revenue: 0 };
              productMap[name].qty += qty;
              productMap[name].revenue += price * qty;
            });

            ordersHTML += createOrderCard({ id, ...data });
          });
        }

        totalComprasEl.textContent = `Total: ${totalOrdenes}`;
        totalVentasEl.textContent = `Total Ventas: $${totalVentas.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;

        const top = Object.entries(productMap)
          .sort((a, b) => b[1].qty - a[1].qty)
          .slice(0, 10);
        productsSummary.innerHTML = top.length
          ? top.map(([n, d]) => `<div class="summary-item"><span><strong>${n}</strong> × ${d.qty}</span><span>$${d.revenue.toFixed(2)}</span></div>`).join('')
          : '<em>No hay productos vendidos aún.</em>';

        ordersContainer.innerHTML = ordersHTML;
        setupActionButtons();
      } catch (err) {
        console.error("Error:", err);
        showToast("Error al cargar: " + err.message);
      }
    }

    // === CREAR TARJETA ===
    function createOrderCard(order) {
      const productosHTML = (order.products || []).map(p => `
        <div class="order-product">
          <span>${p.qty || 1}x ${p.name || 'Producto'}</span>
          <span>$${(Number(p.price) * (p.qty || 1)).toFixed(2)}</span>
        </div>
      `).join('');

      const addr = order.address || {};
      const addressHTML = `
        <strong>Nombre:</strong> ${addr.name || '—'}<br>
        <strong>Teléfono:</strong> ${addr.phone || '—'}<br>
        <strong>Dirección:</strong> ${addr.street || ''}, ${addr.colonia || ''}, C.P. ${addr.cp || ''}<br>
        <strong>Estado:</strong> ${addr.state || '—'}
      `;

      const fecha = order.date?.toDate?.()
        ? new Date(order.date.toDate()).toLocaleString('es-MX')
        : '—';

      const status = order.status || 'paid';
      const statusText = {
        paid: 'Pagado',
        shipped: 'Enviado',
        delivered: 'Entregado',
        cancelled: 'Cancelado'
      }[status] || 'Pagado';

      return `
        <div class="order-card printable-order" id="order-${order.id}">
          <div class="order-header">Detalles de la Compra</div>
          <div class="order-id">Orden: ${order.id}</div>
          <div class="order-total">Total: $${(order.total || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</div>
          <div class="order-products">${productosHTML}</div>
          <div class="order-address">${addressHTML}</div>
          <div class="order-date">${fecha}</div>
          
          <div class="action-btns">
            <button class="print-btn" data-order-id="${order.id}">
              <svg viewBox="0 0 24 24"><path d="M18 7H6V3h12v4zm-2 6c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm2 8H6v-4H4v-2h16v2h-2v4zm0-6H6v-2h12v2z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
              Imprimir
            </button>
            <button class="send-btn" data-order-id="${order.id}">
              <i class="fas fa-paper-plane"></i> Enviar
            </button>
            <button class="status-btn ${status}" data-order-id="${order.id}" data-current="${status}">
              ${statusText}
            </button>
          </div>
        </div>`;
    }

    // === BOTONES ===
    function setupActionButtons() {
      document.querySelectorAll('.print-btn').forEach(btn => {
        btn.onclick = () => printOrder(btn.dataset.orderId);
      });

      document.querySelectorAll('.send-btn').forEach(btn => {
        btn.onclick = () => sendOrder(btn.dataset.orderId);
      });

      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.onclick = () => changeStatus(btn.dataset.orderId, btn.dataset.current);
      });
    }

    window.printOrder = function(id) {
      const el = document.getElementById(`order-${id}`);
      if (!el) return;
      const win = window.open('', '', 'width=800,height=600');
      win.document.write(`
        <!DOCTYPE html><html><head><title>Orden ${id}</title>
        <style>
          body{font-family:'Poppins',sans-serif;padding:30px;color:#000;background:white}
          .order-card{border:1px solid #ddd;border-radius:12px;padding:25px;max-width:600px;margin:auto}
          .order-header{font-size:1.4rem;font-weight:800;margin-bottom:12px}
          .order-id{color:#555;font-size:.9rem}
          .order-total{font-size:1.5rem;font-weight:800;margin:15px 0}
          .order-products{background:#f9f9f9;padding:15px;border-radius:8px;margin:15px 0}
          .order-product{display:flex;justify-content:space-between;margin:8px 0;font-size:1rem}
          .order-address{line-height:1.8;margin:15px 0;font-size:.95rem}
          .order-address strong{display:inline-block;width:130px;font-weight:600}
          .order-date{text-align:right;color:#777;margin-top:20px;font-size:.9rem}
          @page{margin:1.5cm}
        </style></head><body>${el.outerHTML}</body></html>`);
      win.document.close();
      setTimeout(() => { win.print(); setTimeout(() => win.close(), 500); }, 300);
    };

    async function sendOrder(id) {
      if (!confirm('¿Marcar como ENVIADO?')) return;
      try {
        await updateDoc(doc(db, 'orders', id), {
          status: 'shipped',
          shippedAt: serverTimestamp()
        });
        showToast('Enviado');
        loadOrders();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }

    async function changeStatus(id, current) {
      const next = { paid: 'shipped', shipped: 'delivered', delivered: 'cancelled', cancelled: 'paid' }[current] || 'shipped';
      const texts = { paid: 'Pagado', shipped: 'Enviado', delivered: 'Entregado', cancelled: 'Cancelado' };
      if (!confirm(`¿Cambiar a ${texts[next]}?`)) return;
      try {
        await updateDoc(doc(db, 'orders', id), { status: next });
        showToast(`Ahora: ${texts[next]}`);
        loadOrders();
      } catch (err) {
        showToast('Error: ' + err.message);
      }
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // === INICIO ===
    document.addEventListener('DOMContentLoaded', () => {
      loadOrders();
      document.getElementById('sortBtn').addEventListener('click', () => {
        showToast('Ordenado por fecha ↓');
      });
    });
  </script>
</body>
</html>
