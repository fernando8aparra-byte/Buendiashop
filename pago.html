<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago - Efraín Shop</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body { margin: 0; padding: 0; background: #f8f8f8; font-family: 'Poppins', sans-serif; }
    .container { max-width: 900px; margin: 30px auto; padding: 25px; }
    .header { background: #000; color: #fff; padding: 18px 20px; text-align: center; font-weight: 800; font-size: 1.6rem; text-transform: uppercase; }
    
    .form-section { background: #fff; padding: 32px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.12); margin-bottom: 28px; }
    .form-section h3 { margin-top: 0; font-size: 1.55rem; text-transform: uppercase; font-weight: 800; letter-spacing: 0.8px; }
    .form-row { display: flex; gap: 18px; margin-bottom: 18px; }
    .form-group { flex: 1; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 1.05rem; color: #222; }
    .form-group input, .form-group select {
      width: 100%; padding: 16px; border: 2px solid #ccc; border-radius: 10px;
      font-size: 1.1rem; transition: border 0.3s;
    }
    .form-group input:focus, .form-group select:focus { border-color: #000; outline: none; }
    .btn-primary {
      background: #000; color: #fff; padding: 18px; text-align: center; border-radius: 12px;
      font-weight: 800; cursor: pointer; margin-top: 25px; width: 100%; font-size: 1.3rem;
      text-transform: uppercase; letter-spacing: 1.2px; transition: background 0.3s;
    }
    .btn-primary:hover { background: #111; }
    .btn-edit {
      background: #f0f0f0; color: #000; padding: 10px 16px; font-size: 0.9rem;
      border-radius: 8px; cursor: pointer; float: right; font-weight: 600;
    }
    .order-summary { background: #f8f8f8; padding: 28px; border-radius: 16px; }
    .order-item { display: flex; justify-content: space-between; padding: 12px 0; font-size: 1.1rem; border-bottom: 1px solid #ddd; }
    .order-total { font-weight: 900; font-size: 1.7rem; margin-top: 18px; text-align: right; color: #000; }
    .login-required { text-align: center; padding: 50px 20px; background: #fff; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
    .login-required h2 { font-size: 1.8rem; margin-bottom: 16px; }
    .login-required p { color: #555; margin-bottom: 25px; font-size: 1.1rem; }
    .payment-methods { text-align: center; margin: 30px 0; }
    .payment-methods p { font-weight: 700; font-size: 1.2rem; margin-bottom: 20px; color: #222; }
    .payment-logos { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
    .payment-logos img { height: 60px; transition: transform 0.3s; }
    .payment-logos img:hover { transform: scale(1.1); }
    .paypal-container { margin: 30px 0; text-align: center; }
    .paypal-container p { font-weight: 700; font-size: 1.3rem; margin-bottom: 18px; color: #222; }
    .footer { padding: 40px 20px; background: #000; color: #fff; text-align: center; font-size: 0.95rem; margin-top: 50px; }
    .footer a { color: #fff; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="header">EFRAÍN SHOP - PAGO SEGURO</div>
  <div class="container">
    <div id="loginRequired" class="login-required" style="display:none;">
      <h2>Debes iniciar sesión</h2>
      <p>Para continuar con tu compra, necesitas estar registrado.</p>
      <button class="btn-primary" id="goToLogin">Iniciar Sesión / Registrarse</button>
    </div>
    <div id="paymentSection" style="display:none;">
      <div class="form-section">
        <h3>Dirección de Envío</h3>
        <button class="btn-edit" id="editAddressBtn">Editar</button>
        <div id="addressDisplay">
          <p><strong>Nombre:</strong> <span id="dispName">-</span></p>
          <p><strong>Teléfono:</strong> <span id="dispPhone">-</span></p>
          <p><strong>Dirección:</strong> <span id="dispAddress">-</span></p>
          <p><strong>Estado:</strong> <span id="dispState">-</span></p>
        </div>
        <form id="addressForm">
          <div class="form-row">
            <div class="form-group">
              <label>Estado</label>
              <select id="state" required>
                <option value="">Seleccionar estado</option>
                <option>Aguascalientes</option><option>Baja California</option><option>Baja California Sur</option>
                <option>Campeche</option><option>Chiapas</option><option>Chihuahua</option><option>CDMX</option>
                <option>Coahuila</option><option>Colima</option><option>Durango</option><option>Guanajuato</option>
                <option>Guerrero</option><option>Hidalgo</option><option>Jalisco</option><option>México</option>
                <option>Michoacán</option><option>Morelos</option><option>Nayarit</option><option>Nuevo León</option>
                <option>Oaxaca</option><option>Puebla</option><option>Querétaro</option><option>Quintana Roo</option>
                <option>San Luis Potosí</option><option>Sinaloa</option><option>Sonora</option><option>Tabasco</option>
                <option>Tamaulipas</option><option>Tlaxcala</option><option>Veracruz</option><option>Yucatán</option>
                <option>Zacatecas</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Calle y Número</label>
              <input type="text" id="street" placeholder="Ej. Av. Principal 123" required>
            </div>
            <div class="form-group">
              <label>Colonia</label>
              <input type="text" id="colonia" placeholder="Ej. Centro" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Código Postal</label>
              <input type="text" id="cp" placeholder="5 dígitos" maxlength="5" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Nombre Completo (quien recibe)</label>
              <input type="text" id="receiverName" placeholder="Ej. Juan Pérez" required>
            </div>
            <div class="form-group">
              <label>Teléfono</label>
              <input type="text" id="phone" placeholder="10 dígitos" maxlength="10" required>
            </div>
          </div>
          <button type="submit" class="btn-primary">Guardar y Continuar</button>
        </form>
      </div>
      <div class="form-section order-summary">
        <h3>Resumen del Pedido</h3>
        <div id="orderItems"></div>
        <div class="order-total" id="orderTotal">Total: $0</div>
      </div>
      <div class="form-section">
        <h3>Método de Pago</h3>
        <!-- SOLO PAYPAL Y TARJETA -->
        <div class="payment-methods">
          <p>Solo aceptamos:</p>
          <div class="payment-logos">
            <img src="https://www.paypalobjects.com/webstatic/mktg/Logo/PP_Acceptance_Marks_for_LogoCenter_266x142.png" alt="PayPal" style="height: 50px;">
          </div>
        </div>
        <div class="paypal-container">
          <p>Paga con PayPal o <strong>tarjeta de crédito/débito</strong></p>
          <div id="paypal-button-container"></div>
        </div>
      </  </div>
    </div>
  </div>
  <footer class="footer">
    <p>© 2025 Efraín Shop. Todos los derechos reservados.</p>
    <p><a href="mailto:contacto@efrainshop.com">contacto@efrainshop.com</a> • <a href="https://instagram.com/efrainshop" target="_blank">@efrainshop</a></p>
  </footer>

  <!-- PAYPAL SDK (SANDBOX) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AW4TEmQjpm3qc6RrXVegfR9ni1wCPm59KC2s42nJb4npPz-tj3eVcxa9Wd59We8Vb-GAeu5Y67xeUHZL&currency=MXN&intent=capture"></script>

  <!-- SCRIPT FUNCIONAL -->
  <script>
    const cart = JSON.parse(localStorage.getItem('pendingPayment') || '[]');
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:16px 32px;border-radius:12px;font-weight:700;z-index:9999;opacity:0;transition:all 0.3s;font-size:1rem;';
    document.body.appendChild(toast);

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.opacity = '1';
      setTimeout(() => toast.style.opacity = '0', 3000);
    }

    const isLoggedIn = localStorage.getItem('loggedIn') === 'true';
    const loginRequired = document.getElementById('loginRequired');
    const paymentSection = document.getElementById('paymentSection');
    const goToLogin = document.getElementById('goToLogin');

    if (!isLoggedIn) {
      loginRequired.style.display = 'block';
      paymentSection.style.display = 'none';
      localStorage.setItem('redirectAfterLogin', 'pago.html');
      goToLogin.onclick = () => window.location.href = 'login.html';
    } else {
      loginRequired.style.display = 'none';
      paymentSection.style.display = 'block';
    }

    const savedAddress = JSON.parse(localStorage.getItem('shippingAddress') || 'null');
    const addressForm = document.getElementById('addressForm');
    const addressDisplay = document.getElementById('addressDisplay');
    const editAddressBtn = document.getElementById('editAddressBtn');

    if (savedAddress) {
      document.getElementById('dispName').textContent = savedAddress.name;
      document.getElementById('dispPhone').textContent = savedAddress.phone;
      document.getElementById('dispAddress').textContent = `${savedAddress.street}, ${savedAddress.colonia}, C.P. ${savedAddress.cp}`;
      document.getElementById('dispState').textContent = savedAddress.state;
      addressForm.style.display = 'none';
      addressDisplay.style.display = 'block';
      editAddressBtn.style.display = 'block';
    } else {
      addressForm.style.display = 'block';
      addressDisplay.style.display = 'none';
      editAddressBtn.style.display = 'none';
    }

    editAddressBtn.onclick = () => {
      addressForm.style.display = 'block';
      addressDisplay.style.display = 'none';
      editAddressBtn.style.display = 'none';
    };

    addressForm.onsubmit = (e) => {
      e.preventDefault();
      const address = {
        state: document.getElementById('state').value,
        street: document.getElementById('street').value,
        colonia: document.getElementById('colonia').value,
        cp: document.getElementById('cp').value,
        name: document.getElementById('receiverName').value,
        phone: document.getElementById('phone').value
      };
      localStorage.setItem('shippingAddress', JSON.stringify(address));
      location.reload();
    };

    const orderItems = document.getElementById('orderItems');
    const orderTotal = document.getElementById('orderTotal');
    let total = 0;

    cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'order-item';
      div.innerHTML = `<span>${item.name} x${item.qty}</span><span>$${(item.price * item.qty).toLocaleString('es-MX')}</span>`;
      orderItems.appendChild(div);
      total += item.price * item.qty;
    });
    orderTotal.textContent = `Total: $${total.toLocaleString('es-MX')}`;

    if (total > 0 && savedAddress) {
      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'paypal',
          height: 55
        },
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: total.toFixed(2),
                currency_code: 'MXN'
              },
              description: 'Compra en Efraín Shop - Streetwear & Mystery Box',
              custom_id: JSON.stringify({ cart, address: savedAddress, user: localStorage.getItem('userName') })
            }]
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(details => {
            alert(`¡Pago exitoso! Orden: ${details.id}`);
            localStorage.removeItem('pendingPayment');
            localStorage.removeIte
