<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago - Efraín Shop</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body { margin: 0; padding: 0; background: #f8f8f8; font-family: 'Poppins', sans-serif; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; }
    .header { background: #000; color: #fff; padding: 15px 20px; text-align: center; font-weight: 800; font-size: 1.4rem; text-transform: uppercase; }
    .form-section { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .form-section h3 { margin-top: 0; font-size: 1.4rem; text-transform: uppercase; }

    .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
    .form-group { flex: 1; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 1rem; }

    .btn-primary { background: #000; color: #fff; padding: 15px; text-align: center; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; font-size: 1.1rem; }
    .btn-edit { background: #f0f0f0; color: #000; padding: 8px 12px; font-size: 0.8rem; border-radius: 6px; cursor: pointer; float: right; }

    .order-summary { background: #f8f8f8; padding: 20px; border-radius: 12px; }
    .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .order-total { font-weight: 800; font-size: 1.4rem; margin-top: 15px; text-align: right; }

    .login-required { text-align: center; padding: 40px 20px; background: #fff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .login-required h2 { margin-bottom: 15px; }
    .login-required p { color: #666; margin-bottom: 20px; }

    .paypal-container { margin: 20px 0; text-align: center; }
    .paypal-container p { margin-bottom: 15px; font-weight: 600; }

    .footer { padding: 30px 20px; background: #000; color: #fff; text-align: center; font-size: 0.9rem; margin-top: 40px; }
    .footer a { color: #fff; text-decoration: underline; }

    /* NUEVO: PANTALLA DE ÉXITO */
    .success-screen {
      display: none;
      text-align: center;
      padding: 40px 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 600px;
    }
    .success-screen h2 {
      color: #28a745;
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    .success-screen .order-id {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 25px;
    }
    .success-items {
      text-align: left;
      background: #f8f8f8;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .success-items .item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .success-items .item:last-child { border-bottom: none; }
    .success-total {
      font-weight: 800;
      font-size: 1.3rem;
      text-align: right;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <!-- HEADER SIMPLE -->
  <div class="header">EFRAÍN SHOP - PAGO SEGURO</div>

  <div class="container">

    <!-- SI NO ESTÁ LOGUEADO -->
    <div id="loginRequired" class="login-required" style="display:none;">
      <h2>Debes iniciar sesión</h2>
      <p>Para continuar con tu compra, necesitas estar registrado.</p>
      <button class="btn-primary" id="goToLogin">Iniciar Sesión / Registrarse</button>
    </div>

    <!-- FORMULARIO DE ENVÍO (DESPLEGADO DESDE EL INICIO) -->
    <div id="paymentSection" style="display:none;">

      <div class="form-section">
        <h3>Dirección de Envío</h3>
        <button class="btn-edit" id="editAddressBtn">Editar</button>

        <div id="addressDisplay">
          <p><strong>Nombre:</strong> <span id="dispName">-</span></p>
          <p><strong>Teléfono:</strong> <span id="dispPhone">-</span></p>
          <p><strong>Dirección:</strong> <span id="dispAddress">-</span></p>
          <p><strong>Estado:</strong> <span id="dispState">-</span></p>
        </div>

        <form id="addressForm">
          <div class="form-row">
            <div class="form-group">
              <label>Estado</label>
              <select id="state" required>
                <option value="">Seleccionar estado</option>
                <option>Aguascalientes</option>
                <option>Baja California</option>
                <option>Baja California Sur</option>
                <option>Campeche</option>
                <option>Chiapas</option>
                <option>Chihuahua</option>
                <option>CDMX</option>
                <option>Coahuila</option>
                <option>Colima</option>
                <option>Durango</option>
                <option>Guanajuato</option>
                <option>Guerrero</option>
                <option>Hidalgo</option>
                <option>Jalisco</option>
                <option>México</option>
                <option>Michoacán</option>
                <option>Morelos</option>
                <option>Nayarit</option>
                <option>Nuevo León</option>
                <option>Oaxaca</option>
                <option>Puebla</option>
                <option>Querétaro</option>
                <option>Quintana Roo</option>
                <option>San Luis Potosí</option>
                <option>Sinaloa</option>
                <option>Sonora</option>
                <option>Tabasco</option>
                <option>Tamaulipas</option>
                <option>Tlaxcala</option>
                <option>Veracruz</option>
                <option>Yucatán</option>
                <option>Zacatecas</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Calle y Número</label>
              <input type="text" id="street" placeholder="Ej. Av. Principal 123" required>
            </div>
            <div class="form-group">
              <label>Colonia</label>
              <input type="text" id="colonia" placeholder="Ej. Centro" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Código Postal</label>
              <input type="text" id="cp" placeholder="5 dígitos" maxlength="5" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Nombre Completo (quien recibe)</label>
              <input type="text" id="receiverName" placeholder="Ej. Juan Pérez" required>
            </div>
            <div class="form-group">
              <label>Teléfono</label>
              <input type="text" id="phone" placeholder="10 dígitos" maxlength="10" required>
            </div>
          </div>
          <button type="submit" class="btn-primary">Guardar y Continuar</button>
        </form>
      </div>

      <!-- RESUMEN DE PEDIDO -->
      <div class="form-section order-summary">
        <h3>Resumen del Pedido</h3>
        <div id="orderItems"></div>
        <div class="order-total" id="orderTotal">Total: $0</div>
      </div>

      <!-- MÉTODOS DE PAGO -->
      <div class="form-section">
        <h3>Método de Pago</h3>
        <div class="paypal-container">
          <p>Paga de forma segura con PayPal</p>
          <div id="paypal-button-container"></div>
        </div>
        <p style="text-align:center; margin-top:20px; color:#666; font-size:0.9rem;">
          También aceptamos: <strong>Tarjeta de Crédito / Débito</strong> (a través de PayPal)
        </p>
      </div>
    </div>

    <!-- NUEVO: PANTALLA DE ÉXITO -->
    <div id="successScreen" class="success-screen">
      <h2>Pago realizado con éxito</h2>
      <p class="order-id">Tu orden: <strong id="successOrderId"></strong></p>
      <div class="success-items" id="successItems"></div>
      <div class="success-total" id="successTotal"></div>
      <button class="btn-primary" id="goHomeBtn">Ir al Inicio</button>
    </div>
  </div>

  <!-- PIE DE PÁGINA -->
  <footer class="footer">
    <p>© 2025 Efraín Shop. Todos los derechos reservados.</p>
    <p><a href="mailto:contacto@efrainshop.com">contacto@efrainshop.com</a> • <a href="https://instagram.com/efrainshop" target="_blank">@efrainshop</a></p>
  </footer>

  <!-- PAYPAL SDK (SANDBOX) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AdB6bEc3xx0Ned5sYc6Wy6prEgKeZQrfMKtfrCU-tIcvrJNgf8og5nlRkbQKfBRxcIHPmfjY8JsWE6zo&currency=MXN&intent=capture"></script>

  <!-- FIREBASE SDK (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    // === INICIALIZAR FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyBmv4Wtlg295lfsWh1vpDtOHkxMD34vmUE",
      authDomain: "boutique-buendia.firebaseapp.com",
      projectId: "boutique-buendia",
      storageBucket: "boutique-buendia.firebasestorage.app",
      messagingSenderId: "430651152709",
      appId: "1:430651152709:web:aaa54eeb8e3ba64c43062c",
      measurementId: "G-9KJ2330RN7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:14px 28px;border-radius:8px;font-weight:700;z-index:9999;opacity:0;transition:all 0.3s;';
    document.body.appendChild(toast);

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.opacity = '1';
      setTimeout(() => toast.style.opacity = '0', 3000);
    }

    // Verificar login
    const isLoggedIn = localStorage.getItem('loggedIn') === 'true';
    const loginRequired = document.getElementById('loginRequired');
    const paymentSection = document.getElementById('paymentSection');
    const successScreen = document.getElementById('successScreen');
    const goToLogin = document.getElementById('goToLogin');

    if (!isLoggedIn) {
      loginRequired.style.display = 'block';
      paymentSection.style.display = 'none';
      localStorage.setItem('redirectAfterLogin', 'pago.html');
      goToLogin.onclick = () => window.location.href = 'login.html';
    } else {
      loginRequired.style.display = 'none';
      paymentSection.style.display = 'block';
    }

    // Cargar dirección
    const savedAddress = JSON.parse(localStorage.getItem('shippingAddress') || 'null');
    const addressForm = document.getElementById('addressForm');
    const addressDisplay = document.getElementById('addressDisplay');
    const editAddressBtn = document.getElementById('editAddressBtn');

    if (savedAddress) {
      document.getElementById('dispName').textContent = savedAddress.name;
      document.getElementById('dispPhone').textContent = savedAddress.phone;
      document.getElementById('dispAddress').textContent = `${savedAddress.street}, ${savedAddress.colonia}, C.P. ${savedAddress.cp}`;
      document.getElementById('dispState').textContent = savedAddress.state;
      addressForm.style.display = 'none';
      addressDisplay.style.display = 'block';
      editAddressBtn.style.display = 'block';
    } else {
      addressForm.style.display = 'block';
      addressDisplay.style.display = 'none';
      editAddressBtn.style.display = 'none';
    }

    editAddressBtn.onclick = () => {
      addressForm.style.display = 'block';
      addressDisplay.style.display = 'none';
      editAddressBtn.style.display = 'none';
    };

    addressForm.onsubmit = (e) => {
      e.preventDefault();
      const address = {
        state: document.getElementById('state').value,
        street: document.getElementById('street').value,
        colonia: document.getElementById('colonia').value,
        cp: document.getElementById('cp').value,
        name: document.getElementById('receiverName').value,
        phone: document.getElementById('phone').value
      };
      localStorage.setItem('shippingAddress', JSON.stringify(address));
      location.reload();
    };

    // Cargar carrito desde Firebase (colección 'carts', documento por userName, campo 'items')
    const userId = localStorage.getItem('userName') || 'anonimo';
    const cartRef = db.collection('carts').doc(userId);
    cartRef.get().then((doc) => {
      let cart = [];
      if (doc.exists) {
        cart = doc.data().items || [];
      }

      // Resumen del pedido
      const orderItems = document.getElementById('orderItems');
      const orderTotal = document.getElementById('orderTotal');
      let total = 0;

      cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'order-item';
        div.innerHTML = `<span>${item.name} x${item.qty}</span><span>$${(item.price * item.qty).toLocaleString()}</span>`;
        orderItems.appendChild(div);
        total += item.price * item.qty;
      });
      orderTotal.textContent = `Total: $${total.toLocaleString()}`;

      // PayPal Button
      if (total > 0 && savedAddress) {
        paypal.Buttons({
          style: {
            shape: 'rect',
            color: 'gold',
            layout: 'vertical',
            label: 'paypal'
          },
          createOrder: (data, actions) => {
            return actions.order.create({
              purchase_units: [{
                amount: { value: total.toFixed(2), currency_code: 'MXN' },
                description: 'Compra en Efraín Shop - Streetwear & Mystery Box',
                custom_id: `efrain-${Date.now()}-${total.toFixed(0)}`
              }]
            });
          },
          onApprove: (data, actions) => {
            return actions.order.capture().then(details => {
              console.log('PEDIDO PARA ADMIN:', { cart, address: savedAddress, total, orderId: details.id, user: details.payer });

              // === MAPEO DE CÓDIGOS DE ESTADO ===
              const stateCodes = {
                "Aguascalientes": "AGS","Baja California": "BC","Baja California Sur": "BCS","Campeche": "CAM","Chiapas": "CHIS","Chihuahua": "CHIH","CDMX": "CDMX","Coahuila": "COAH","Colima": "COL","Durango": "DGO","Guanajuato": "GTO","Guerrero": "GRO","Hidalgo": "HGO","Jalisco": "JAL","México": "MEX","Michoacán": "MICH","Morelos": "MOR","Nayarit": "NAY","Nuevo León": "NL","Oaxaca": "OAX","Puebla": "PUE","Querétaro": "QRO","Quintana Roo": "QROO","San Luis Potosí": "SLP","Sinaloa": "SIN","Sonora": "SON","Tabasco": "TAB","Tamaulipas": "TAM","Tlaxcala": "TLAX","Veracruz": "VER","Yucatán": "YUC","Zacatecas": "ZAC"
              };

              // === FORMATEAR Y ENVIAR A FIRESTORE ===
              const orderData = {
                userId: localStorage.getItem('userName') || 'anonimo',
                date: firebase.firestore.FieldValue.serverTimestamp(),
                total: total,
                paymentId: details.id,
                status: "paid",
                address: {
                  name: savedAddress.name,
                  phone: savedAddress.phone,
                  street: savedAddress.street,
                  colonia: savedAddress.colonia,
                  cp: savedAddress.cp,
                  state: savedAddress.state,
                  stateCode: stateCodes[savedAddress.state] || savedAddress.state
                },
                products: cart.map(item => ({
                  name: item.name,
                  qty: item.qty,
                  price: item.price
                }))
              };

              db.collection('orders').doc(details.id).set(orderData)
                .then(() => {
                  console.log('Orden guardada en Firebase con ID:', details.id);
                  // Limpiar carrito en Firebase
                  cartRef.set({ items: [] })
                    .then(() => {
                      console.log('Carrito limpiado en Firebase');
                    })
                    .catch((error) => {
                      console.error('Error al limpiar carrito:', error);
                    });
                })
                .catch((error) => {
                  console.error('Error al guardar en Firebase:', error);
                });

              // === MOSTRAR PANTALLA DE ÉXITO ===
              paymentSection.style.display = 'none';
              successScreen.style.display = 'block';

              document.getElementById('successOrderId').textContent = details.id;

              const successItems = document.getElementById('successItems');
              successItems.innerHTML = '';
              let successTotal = 0;
              cart.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span>${item.name} x${item.qty}</span><span>$${(item.price * item.qty).toLocaleString()}</span>`;
                successItems.appendChild(div);
                successTotal += item.price * item.qty;
              });
              document.getElementById('successTotal').textContent = `Total: $${successTotal.toLocaleString()}`;

              document.getElementById('goHomeBtn').onclick = () => {
                localStorage.removeItem('shippingAddress');
                window.location.href = 'index.html';
              };
            });
          },
          onError: (err) => {
            console.error(err);
            showToast('Error en el pago. Intenta de nuevo.');
          }
        }).render('#paypal-button-container');
      } else if (total === 0) {
        document.querySelector('.paypal-container').innerHTML = '<p style="color:#999;">No hay productos en el carrito.</p>';
      }
    }).catch((error) => {
      console.error('Error al cargar el carrito desde Firebase:', error);
      showToast('Error al cargar el carrito. Intenta de nuevo.');
    });
  </script>
</body>
</html>
